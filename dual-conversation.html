<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§Ø¯Ø«Ø© Ø«Ù†Ø§Ø¦ÙŠØ© Ù…Ø­Ø³Ù†Ø© - Ù…ØªØ±Ø¬Ù… ØµÙˆØªÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© */
            --brand-bg: #ffffff;
            --brand-text: #0f172a;
            --brand-muted: #64748b;
            --brand-primary: #3b82f6;
            --brand-primary-soft: #eff6ff;
            --brand-secondary: #10b981;
            --brand-secondary-soft: #ecfdf5;
            --panel-radius: 18px;
            --bubble-radius: 14px;
            --shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
            
            /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ† */
            --person1-color: #3b82f6;
            --person2-color: #10b981;
            --person1-bg: #eff6ff;
            --person2-bg: #ecfdf5;
        }
        
        /* Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
        @media (max-width: 480px) {
            .top-menu {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
                padding: 6px 8px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: auto;
            }
            
            .app-logo {
                height: 30px;
            }
            
            .langbar {
                padding: 6px 10px;
                gap: 8px;
                font-size: 0.8rem;
            }
            
            .lang-section {
                gap: 4px;
            }
            
            .swapbtn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .connection-indicator {
                font-size: 10px;
                padding: 2px 6px;
            }
        }
        
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            color: var(--brand-text);
            background: var(--brand-bg);
            direction: rtl;
        }
        
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            gap: 14px;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ§Øª */
        .langbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: white;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .connection-indicator.online {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .connection-indicator.offline {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .connection-status {
            font-size: 14px;
        }
        
        .lang-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .lang-section.left { justify-content: flex-start; }
        .lang-section.right { justify-content: flex-end; }
        
        .flag { font-size: 1.5rem; }
        
        .swapbtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2rem;
            min-width: 48px;
            min-height: 48px;
        }
        
        .swapbtn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .swapbtn:active { transform: scale(0.96); }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .top-menu {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: white;
            border-radius: 14px;
            box-shadow: var(--shadow);
            margin-bottom: 12px;
        }
        
        /* Ù‚Ø³Ù… Ø§Ù„Ù„ÙˆØ¬Ùˆ */
        .logo-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            margin-bottom: 12px;
        }
        
        .app-logo {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            min-width: 100px;
            min-height: 44px;
        }
        
        .btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
        }
        
        .btn:active { transform: scale(0.96); }
        
        .btn.save { background: var(--brand-primary); color: white; }
        .btn.clear { background: #ef4444; color: white; }
        .btn.dark { background: #374151; color: white; }
        .btn.home { background: var(--brand-secondary); color: white; }
        
        /* Ø£Ø²Ø±Ø§Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ */
        .mode-switcher {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        
        .mode-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 18px 28px;
            border-radius: 16px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--brand-primary);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: white;
            border-color: var(--brand-primary);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .mode-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }
        
        .mode-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }
        
        .mode-text {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .mode-desc {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .mode-btn.active .mode-desc {
            opacity: 0.9;
        }
        
        /* Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .panes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* ÙˆØ¶Ø¹ Face-to-Face */
        .panes.face-to-face {
            grid-template-columns: 1fr 1fr;
        }
        
        /* ÙˆØ¶Ø¹ Remote */
        .panes.remote {
            grid-template-columns: 1fr;
        }
        
        .remote-chat-container {
            display: none;
            background: white;
            border-radius: var(--panel-radius);
            box-shadow: var(--shadow);
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .remote-chat-container.active {
            display: block;
        }
        
        .remote-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .remote-chat-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--brand-primary);
        }
        
        .connection-status-remote {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--brand-secondary-soft);
            color: var(--brand-secondary);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .remote-language-selector {
            display: flex;
            align-items: end;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .language-option {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .lang-swap-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
            margin-bottom: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 48px;
            min-height: 48px;
        }
        
        .lang-swap-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .lang-swap-btn:active {
            transform: scale(0.95);
        }
        
        .language-option label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--brand-text);
        }
        
        .lang-select-remote {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: var(--brand-text);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .lang-select-remote:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .lang-select-remote:hover {
            border-color: var(--brand-primary);
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: slideInChat 0.3s ease;
        }
        
        .chat-bubble.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--brand-primary), #2563eb);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .chat-bubble.received {
            align-self: flex-start;
            background: white;
            color: var(--brand-text);
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }
        
        .bubble-content {
            margin-bottom: 4px;
        }
        
        .bubble-original {
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .bubble-translation {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .bubble-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: left;
        }
        
        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: var(--brand-primary);
        }
        
        .send-btn, .voice-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            min-width: 52px;
            min-height: 52px;
        }
        
        .send-btn {
            background: var(--brand-primary);
            color: white;
        }
        
        .send-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .voice-btn {
            background: var(--brand-secondary);
            color: white;
        }
        
        .voice-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        .voice-btn.recording {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes slideInChat {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pane {
            border-radius: var(--panel-radius);
            padding: 16px;
            min-height: 40vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 12px;
            box-shadow: var(--shadow);
            background: #fff;
            border: 2px solid #eef2f7;
            position: relative;
            min-width: 300px;
        }
        
        .pane.a {
            background: var(--brand-primary-soft);
            border-color: var(--brand-primary);
        }
        
        .pane.b {
            background: var(--brand-secondary-soft);
            border-color: var(--brand-secondary);
        }
        
        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pane-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .pane.a .pane-title { color: var(--brand-primary); }
        .pane.b .pane-title { color: var(--brand-secondary); }
        
        .lang-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 0.9rem;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .scroll {
            overflow: auto;
            display: grid;
            gap: 10px;
            align-content: start;
            padding: 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            min-height: 200px;
        }
        
        /* Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: #64748b;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.7;
        }
        
        .empty-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .message {
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            animation: slideInMessage 0.3s ease-out;
        }
        
        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.original {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
        }
        
        .message.translation {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-left: 4px solid #9c27b0;
        }
        
        .message-content {
            margin-bottom: 4px;
        }
        
        .message-text {
            font-size: 1rem;
            line-height: 1.4;
            color: #333;
        }
        
        .original-text {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            font-style: italic;
        }
        
        .translated-text {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #888;
            text-align: right;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­ÙƒÙ… */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .mic-btn, .play-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .mic-btn {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            flex: 1;
            min-width: 120px;
            min-height: 60px;
        }
        
        .mic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .mic-btn.listening {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .play-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            min-width: 120px;
            min-height: 60px;
            color: white;
        }
        
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .mic-icon, .play-icon {
            font-size: 1.2rem;
        }
        
        .mic-text {
            font-size: 0.8rem;
            text-align: center;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .panes {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .pane {
                min-height: 30vh;
            }
            
            .pane-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .mic-btn {
                width: 100%;
            }
        }
            background: rgba(255, 255, 255, 0.7);






        .scroll {
            background: rgba(255,255,255,0.7);
        }
        
        .message-group {
            display: grid;
            gap: 4px;
            max-width: 80%;
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .message-group.me { justify-self: end; }
        .message-group.them { justify-self: start; }
        
        .bubble {
            padding: 10px 14px;
            border-radius: var(--bubble-radius);
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bubble.original {
            font-weight: 600;
            border-left: 4px solid var(--brand-primary);
        }
        
        .bubble.translation {
            font-size: 0.92rem;
            color: var(--brand-muted);
            background: #f8fafc;
            border-left: 4px solid var(--brand-secondary);
        }
        
        .message-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .action-btn {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            background: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.2);
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        
        .mic {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid #cbd5e1;
            background: #fff;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .mic:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .mic[data-state="listening"] {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background: var(--brand-primary-soft);
        }
        
        .mic-icon {
            font-size: 1.5rem;
        }
        
        .mic-text {
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 999px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }
        
        /* Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØª */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .voice-wave.active { opacity: 1; }
        
        .wave-bar {
            width: 3px;
            background: currentColor;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; height: 10px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 20px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 15px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 10px; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        .footer {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            position: sticky;
            bottom: 8px;
            margin-top: 16px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .hands-free {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hands-free:hover {
            color: var(--brand-primary);
        }
        
        .hands-free.active {
            background: var(--brand-primary);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .hands-free.active::before {
            content: 'ğŸ¤–';
            margin-right: 4px;
        }
        
        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .dark-mode {
            --brand-bg: #111827;
            --brand-text: #f9fafb;
            --brand-muted: #9ca3af;
            --brand-primary-soft: #1e3a8a;
            --brand-secondary-soft: #065f46;
        }
        
        .dark-mode .pane,
        .dark-mode .header-controls,
        .dark-mode .footer {
            background: #1f2937;
            border-color: #374151;
        }
        
        .dark-mode .bubble {
            background: #374151;
            color: #f9fafb;
        }
        
        .dark-mode .bubble.translation {
            background: #4b5563;
        }
        
        .dark-mode .header h1 {
            color: #f9fafb;
        }
        
        .dark-mode .controls button {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .controls button:hover {
            background: #4b5563;
        }
        
        .dark-mode .controls button.active {
            background: var(--brand-primary);
            color: white;
        }
        
        .dark-mode .hands-free {
            color: #d1d5db;
        }
        
        .dark-mode .hands-free:hover {
            color: var(--brand-primary);
        }
        
        .dark-mode .connection-indicator {
            background: #374151;
            border-color: #4b5563;
        }
        
        .dark-mode .connection-status.online {
            color: #10b981;
        }
        
        .dark-mode .connection-status.offline {
            color: #ef4444;
        }
        
        .dark-mode .connection-status {
            color: #d1d5db;
        }
        
        .dark-mode #stats {
            color: #9ca3af;
        }
        
        .dark-mode .mic-text {
            color: #d1d5db;
        }
        
        .dark-mode .btn {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .btn:hover {
            background: #4b5563;
        }
        
        .dark-mode .btn.dark {
            background: #1f2937;
            color: #f9fafb;
        }
        
        .dark-mode .btn.dark:hover {
            background: #374151;
        }
        
        .dark-mode select {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode select:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dark-mode .message-actions button {
            background: #4b5563;
            color: #d1d5db;
        }
        
        .dark-mode .message-actions button:hover {
            background: #6b7280;
            color: #f9fafb;
        }
        
        .dark-mode .voice-wave .wave-bar {
            background: currentColor;
        }
        
        .dark-mode .scroll {
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .dark-mode .scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .dark-mode .remote-language-selector {
            background: #1f2937;
            border-color: #374151;
        }
        
        .dark-mode .language-option label {
            color: #f9fafb;
        }
        
        .dark-mode .lang-select-remote {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .lang-select-remote:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dark-mode .lang-select-remote:hover {
            border-color: var(--brand-primary);
        }
        
        .dark-mode .lang-swap-btn {
            background: var(--brand-primary);
            color: white;
        }
        
        .dark-mode .lang-swap-btn:hover {
            background: #2563eb;
        }
        

        

        

        

        

        
        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (min-width: 1024px) {
            .panes {
                grid-template-columns: 1fr 1fr;
            }
            .pane {
                min-height: 60vh;
            }
        }
        
        @media (max-width: 768px) {
            .wrap {
                padding: 8px;
                gap: 8px;
            }
            
            .top-menu {
                padding: 8px 12px;
                gap: 8px;
                margin-bottom: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                gap: 4px;
            }
            
            .btn span {
                font-size: 0.9rem;
            }
            
            .logo-section {
                padding: 4px;
                margin-bottom: 8px;
            }
            
            .app-logo {
                height: 35px;
            }
            
            .langbar {
                padding: 8px 12px;
                margin-bottom: 12px;
                font-size: 0.85rem;
            }
            
            .swapbtn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .pane {
                padding: 12px;
                min-height: 35vh;
            }
        }

        /* Ø£Ù†Ù…Ø§Ø· ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .user-matching-interface {
            animation: fadeIn 0.3s ease-in;
        }

        .user-matching-interface button {
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .user-matching-interface button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .connection-interface {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ØªØ­Ø³ÙŠÙ† Ø£Ù†Ù…Ø§Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        #usersList {
            max-height: 300px;
            overflow-y: auto;
        }

        #usersList::-webkit-scrollbar {
            width: 6px;
        }

        #usersList::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #usersList::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #usersList::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
        .connection-status-remote {
            transition: all 0.3s ease;
        }

        .connection-status-remote:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="wrap">
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
        <div class="top-menu">
            <button class="btn home" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                <span>ğŸ </span>
                Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>

            <button class="btn dark" id="darkMode" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                <span>ğŸŒ™</span>
                Ù„ÙŠÙ„ÙŠ
            </button>
            <button class="btn save" id="saveChat" title="Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                <span>ğŸ’¾</span>
                Ø­ÙØ¸
            </button>
            <button class="btn clear" id="clearChat" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                <span>ğŸ—‘ï¸</span>
                Ù…Ø³Ø­
            </button>
        </div>
        
        <!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
        <div class="logo-section">
            <img src="assets/logo.svg" alt="LingoLink Logo" class="app-logo" style="height: 50px;">
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ -->
        <div class="mode-switcher">
            <button class="mode-btn active" id="faceToFaceMode" data-mode="face-to-face">
                <span class="mode-icon">ğŸ‘¥</span>
                <span class="mode-text">ÙˆØ¬Ù‡Ø§Ù‹ Ù„ÙˆØ¬Ù‡</span>
                <span class="mode-desc">Face-to-Face</span>
            </button>
            <button class="mode-btn" id="remoteMode" data-mode="remote">
                <span class="mode-icon">ğŸŒ</span>
                <span class="mode-text">Ø¹Ù† Ø¨ÙØ¹Ø¯</span>
                <span class="mode-desc">Remote</span>
            </button>
        </div>


        
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆØ¶Ø¹ Remote -->
        <div class="remote-chat-container" id="remoteChatContainer">
            <div class="remote-chat-header">
                <h2 class="remote-chat-title">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯</h2>
                <div class="connection-status-remote" id="remoteConnectionStatus">
                    <span>ğŸŸ¢</span>
                    <span>Ù…ØªØµÙ„</span>
                </div>
                
                <div class="connection-indicator" id="connectionIndicator">
                    <span class="connection-status" id="connectionStatus">ğŸŸ¢</span>
                    <span id="connectionText">Ù…ØªØµÙ„</span>
                </div>
            </div>
            
            <!-- Ù…Ø±Ø¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ§Øª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯ -->
            <div class="remote-language-selector" id="remoteLangSelector">
                <div class="language-option">
                    <label for="speakerLang" style="font-size: 0.85rem; font-weight: 600; color: #475569;">Ù„ØºØ© Ø§Ù„Ù…ØªØ­Ø¯Ø«:</label>
                    <select class="lang-select" id="speakerLang">
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡ªğŸ‡¬</option>
                        <option value="en">English ğŸ‡ºğŸ‡¸</option>
                        <option value="fr">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                        <option value="es">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                        <option value="de">Deutsch ğŸ‡©ğŸ‡ª</option>
                        <option value="it">Italiano ğŸ‡®ğŸ‡¹</option>
                        <option value="pt">PortuguÃªs ğŸ‡µğŸ‡¹</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
                        <option value="ja">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
                        <option value="ko">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
                        <option value="zh">ä¸­æ–‡ ğŸ‡¨ğŸ‡³</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ ğŸ‡®ğŸ‡³</option>
                        <option value="tr">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
                        <option value="nl">Nederlands ğŸ‡³ğŸ‡±</option>
                    </select>
                </div>
                
                <button class="lang-swap-btn" id="langSwapBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª">
                    â‡„
                </button>
                
                <div class="language-option">
                    <label for="receiverLang" style="font-size: 0.85rem; font-weight: 600; color: #475569;">Ù„ØºØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„:</label>
                    <select class="lang-select" id="receiverLang">
                        <option value="en">English ğŸ‡ºğŸ‡¸</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡ªğŸ‡¬</option>
                        <option value="fr">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                        <option value="es">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                        <option value="de">Deutsch ğŸ‡©ğŸ‡ª</option>
                        <option value="it">Italiano ğŸ‡®ğŸ‡¹</option>
                        <option value="pt">PortuguÃªs ğŸ‡µğŸ‡¹</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
                        <option value="ja">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
                        <option value="ko">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
                        <option value="zh">ä¸­æ–‡ ğŸ‡¨ğŸ‡³</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ ğŸ‡®ğŸ‡³</option>
                        <option value="tr">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
                        <option value="nl">Nederlands ğŸ‡³ğŸ‡±</option>
                    </select>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." dir="rtl">
                <button class="voice-btn" id="voiceBtn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">
                    ğŸ¤
                </button>
                <button class="send-btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">
                    â¤
                </button>
            </div>
        </div>
        
        <!-- ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¶Ø¹ ÙˆØ¬Ù‡Ø§Ù‹ Ù„ÙˆØ¬Ù‡ -->
        <div class="panes" id="conversationPanes">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø£ÙˆÙ„ -->
            <div class="pane a" id="paneA">
                <div class="pane-header">
                    <h3 class="pane-title">ğŸ‘¤ Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø£ÙˆÙ„</h3>
                    <select class="lang-select" id="langA">
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en">English</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                        <option value="tr">TÃ¼rkÃ§e</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                    </select>
                </div>
                
                <div class="scroll" id="scrollA">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-text">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="mic-btn" id="micA" data-speaker="a" title="Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«">
                        <span class="mic-icon">ğŸ¤</span>
                        <span class="mic-text">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«</span>
                    </button>
                    <button class="play-btn" id="playA" title="ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµÙˆØªÙŠØ©" style="display: none;">
                        <span class="play-icon">ğŸ”Š</span>
                    </button>
                </div>
            </div>
            
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø«Ø§Ù†ÙŠ -->
            <div class="pane b" id="paneB">
                <div class="pane-header">
                    <h3 class="pane-title">ğŸ‘¤ Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø«Ø§Ù†ÙŠ</h3>
                    <select class="lang-select" id="langB">
                        <option value="en">English</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                        <option value="tr">TÃ¼rkÃ§e</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                    </select>
                </div>
                
                <div class="scroll" id="scrollB">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-text">Click microphone to start speaking</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="mic-btn" id="micB" data-speaker="b" title="Click to speak">
                        <span class="mic-icon">ğŸ¤</span>
                        <span class="mic-text">Click to speak</span>
                    </button>
                    <button class="play-btn" id="playB" title="Play audio translation" style="display: none;">
                        <span class="play-icon">ğŸ”Š</span>
                    </button>
                </div>
            </div>
        </div>

        
        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
        <div class="footer">

            <div style="font-size: 0.8rem; color: var(--brand-muted);" id="stats">
                Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: 0 | Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª: 0
            </div>
        </div>
    </div>
    

    
    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let recognition;
        let isListening = false;
        let currentSpeaker = null;
        let conversationData = [];
        let messageCount = 0;
        let translationCount = 0;
        let lastProcessedText = '';
        let processingTimeout = null;
        

        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        let recordingTimeout = null;
        let maxRecordingTime = 300000; // 300 Ø«Ø§Ù†ÙŠØ© (5 Ø¯Ù‚Ø§Ø¦Ù‚)
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
            setupEventListeners();
            updateStats();
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false; // ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ false Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                recognition.interimResults = false; // ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ false Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·
                recognition.maxAlternatives = 1; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø¯ÙŠÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                
                recognition.onstart = function() {
                    isListening = true;
                    updateMicState(currentSpeaker, 'listening');
                };
                
                recognition.onresult = function(event) {
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·
                    const result = event.results[event.results.length - 1];
                    if (result.isFinal) {
                        const transcript = result[0].transcript;
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        networkRetryAttempts = 0;
                        console.log('Speech recognition successful, network retry attempts reset');
                        processTranscript(transcript, currentSpeaker);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…:', event.error);
                    
                    // ØªØ³Ø¬ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø®Ø·Ø£
                    console.warn('Speech Recognition Error Details:', {
                        error: event.error,
                        speaker: currentSpeaker,
                        timestamp: new Date().toISOString(),
                        isListening: isListening,
                        networkRetryAttempts: networkRetryAttempts
                    });
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                    let errorMessage = '';
                    let showRetryOption = false;
                    
                    switch(event.error) {
                        case 'network':
                            console.log('Network error detected, handling with improved retry mechanism');
                            handleNetworkError(currentSpeaker);
                            return;
                        case 'not-allowed':
                            errorMessage = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙÙ„ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.';
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ø¹Ù†Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                            networkRetryAttempts = 0;
                            break;
                        case 'no-speech':
                            errorMessage = 'Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ ÙƒÙ„Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙŠØ¹Ù…Ù„ ÙˆØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­.';
                            showRetryOption = true;
                            break;
                        case 'audio-capture':
                            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØª. ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡.';
                            showRetryOption = true;
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
                            showRetryOption = true;
                            break;
                        case 'bad-grammar':
                            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';
                            showRetryOption = true;
                            break;
                        case 'language-not-supported':
                            errorMessage = 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.';
                            showRetryOption = true;
                            break;
                        case 'aborted':
                            // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‚ØµÙˆØ¯
                            stopListening();
                            return;
                        default:
                            errorMessage = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª: ${event.error}. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...`;
                            showRetryOption = true;
                            break;
                    }
                    
                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø®ÙŠØ§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹
                    if (showRetryOption) {
                        showErrorMessageWithRetry(errorMessage, currentSpeaker);
                    } else {
                        showErrorMessage(errorMessage);
                    }
                    
                    stopListening();
                };
                
                recognition.onend = function() {
                    stopListening();
                };
            } else {
                alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…');
            }
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupEventListeners() {

            document.getElementById('darkMode').addEventListener('click', toggleDarkMode);
            document.getElementById('saveChat').addEventListener('click', saveConversation);
            document.getElementById('clearChat').addEventListener('click', clearConversation);
            document.getElementById('homeBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

        }
        

        
        // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        function toggleListening(speaker) {
            if (isListening && currentSpeaker === speaker) {
                stopListening();
            } else {
                startListening(speaker);
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        function startListening(speaker) {
            if (isListening) {
                stopListening();
            }
            
            currentSpeaker = speaker;
            const lang = document.getElementById(`lang${speaker}`).value;
            recognition.lang = lang;
            recognition.start();
            
            showVoiceWave(speaker);
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ÙƒÙ„Ø§Ù… Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            lastSpeechTime = Date.now();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ timeout Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (3 Ø¯Ù‚Ø§Ø¦Ù‚ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            recordingTimeout = setTimeout(() => {
                if (isListening) {
                    showErrorMessage('Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© (3 Ø¯Ù‚Ø§Ø¦Ù‚). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    stopListening();
                }
            }, maxRecordingTime);
            
            // Ø¨Ø¯Ø¡ ÙƒØ´Ù Ø§Ù„ØµÙ…Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (isHandsfreeMode) {
                detectSilenceInHandsfree();
            }
        }
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            
            // ØªÙ†Ø¸ÙŠÙ timeout Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            isListening = false;
            updateMicState(currentSpeaker, 'idle');
            hideVoiceWave(currentSpeaker);
            currentSpeaker = null;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†
        function updateMicState(speaker, state) {
            if (!speaker) return;
            
            const mic = document.getElementById(`mic${speaker}`);
            const micText = mic.querySelector('.mic-text');
            
            mic.setAttribute('data-state', state);
            
            if (state === 'listening') {
                micText.textContent = speaker === 'A' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...' : 'Listening...';
            } else {
                micText.textContent = speaker === 'A' ? 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«' : 'Click to speak';
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØª
        function showVoiceWave(speaker) {
            const wave = document.getElementById(`wave${speaker}`);
            wave.classList.add('active');
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØª
        function hideVoiceWave(speaker) {
            if (!speaker) return;
            const wave = document.getElementById(`wave${speaker}`);
            wave.classList.remove('active');
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø·ÙˆÙ‚
        async function processTranscript(text, speaker) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            const cleanText = text.trim();
            
            // ØªØ¬Ù†Ø¨ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ Ø§Ù„Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
            if (!cleanText || cleanText.length < 2) {
                return;
            }
            
            // Ù…Ù†Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙØ³ Ø§Ù„Ù†Øµ Ù…Ø±ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†
            if (cleanText === lastProcessedText) {
                return;
            }
            
            // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹Ù„Ù‚Ø©
            if (processingTimeout) {
                clearTimeout(processingTimeout);
            }
            
            // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Øµ
            processingTimeout = setTimeout(async () => {
                lastProcessedText = cleanText;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ÙƒÙ„Ø§Ù… Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                lastSpeechTime = Date.now();
                
                const sourceLang = document.getElementById(`lang${speaker}`).value;
                const targetLang = document.getElementById(`lang${speaker === 'A' ? 'B' : 'A'}`).value;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                addMessage(cleanText, speaker, 'original');
                
                // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ
                try {
                    const translation = await translateText(cleanText, sourceLang, targetLang);
                    addMessage(translation, speaker === 'A' ? 'B' : 'A', 'translation');
                    
                    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© ØµÙˆØªÙŠØ§Ù‹
                    speakText(translation, targetLang);
                    
                    translationCount++;
                    updateStats();
                    

                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                }
                
                messageCount++;
                updateStats();
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
                stopListening();
                
                // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
                setTimeout(() => {
                    lastProcessedText = '';
                }, 3000);
            }, 500); // ØªØ£Ø®ÙŠØ± Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Øµ
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function addMessage(text, targetSpeaker, type) {
            const chatArea = document.getElementById(`scroll${targetSpeaker}`);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            const placeholder = chatArea.querySelector('[style*="text-align: center"]');
            if (placeholder) {
                placeholder.remove();
            }
            
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${type === 'original' ? 'me' : 'them'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `bubble ${type}`;
            bubble.textContent = text;
            
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            if (type === 'translation') {
                const playBtn = document.createElement('button');
                playBtn.className = 'action-btn';
                playBtn.textContent = 'ğŸ”Š';
                playBtn.title = 'ØªØ´ØºÙŠÙ„';
                playBtn.onclick = () => {
                    const lang = document.getElementById(`lang${targetSpeaker}`).value;
                    speakText(text, lang);
                };
                actions.appendChild(playBtn);
            }
            
            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn';
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'ØªØ¹Ø¯ÙŠÙ„';
            editBtn.onclick = () => editMessage(bubble);
            actions.appendChild(editBtn);
            
            messageGroup.appendChild(bubble);
            messageGroup.appendChild(actions);
            chatArea.appendChild(messageGroup);
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // Ø­ÙØ¸ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            conversationData.push({
                text: text,
                speaker: targetSpeaker,
                type: type,
                timestamp: new Date().toISOString()
            });
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø©
        function editMessage(bubble) {
            const currentText = bubble.textContent;
            const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', currentText);
            if (newText && newText !== currentText) {
                bubble.textContent = newText;
            }
        }
        
        // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ±Ø¬Ù…Ø§Øª
        const translationCache = new Map();
        
        // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        async function translateText(text, sourceLang, targetLang) {
            if (sourceLang === targetLang) {
                return text;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
            const cacheKey = `${text}_${sourceLang}_${targetLang}`;
            if (translationCache.has(cacheKey)) {
                return translationCache.get(cacheKey);
            }
            
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù…Ø¹ timeout Ù…Ø­Ø³Ù†
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 Ø«ÙˆØ§Ù†Ù timeout
                
                const response = await fetch(
                    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`,
                    { 
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                    const translation = data.responseData.translatedText;
                    
                    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                    translationCache.set(cacheKey, translation);
                    
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ ÙƒØ¨ÙŠØ±Ø§Ù‹
                    if (translationCache.size > 100) {
                        const firstKey = translationCache.keys().next().value;
                        translationCache.delete(firstKey);
                    }
                    
                    return translation;
                } else {
                    throw new Error('Invalid response from translation service');
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ø¯Ù…Ø© ØªØ±Ø¬Ù…Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                try {
                    return await fallbackTranslation(text, sourceLang, targetLang);
                } catch (fallbackError) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', fallbackError);
                    showErrorMessage('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    return text;
                }
            }
        }
        
        // Ø®Ø¯Ù…Ø© ØªØ±Ø¬Ù…Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        async function fallbackTranslation(text, sourceLang, targetLang) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Translate ÙƒØ®Ø¯Ù…Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const response = await fetch(
                `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`,
                {
                    headers: {
                        'Accept': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error('Fallback translation failed');
            }
            
            const data = await response.json();
            
            if (data && data[0] && data[0][0] && data[0][0][0]) {
                return data[0][0][0];
            } else {
                throw new Error('Invalid fallback response');
            }
        }
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Øµ ØµÙˆØªÙŠØ§Ù‹ Ø§Ù„Ù…Ø­Ø³Ù†
        function speakText(text, lang) {
            if ('speechSynthesis' in window) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØªÙŠ Ø³Ø§Ø¨Ù‚
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 1.0; // Ø³Ø±Ø¹Ø© Ù…Ø­Ø³Ù†Ø©
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                utterance.onerror = function(event) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ:', event.error);
                };
                
                // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
                if (text.length > 200) {
                    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø£ØµØºØ±
                    const chunks = text.match(/.{1,200}(\s|$)/g) || [text];
                    let currentChunk = 0;
                    
                    function speakNextChunk() {
                        if (currentChunk < chunks.length) {
                            const chunkUtterance = new SpeechSynthesisUtterance(chunks[currentChunk]);
                            chunkUtterance.lang = lang;
                            chunkUtterance.rate = 1.0;
                            chunkUtterance.pitch = 1.0;
                            chunkUtterance.volume = 0.8;
                            
                            chunkUtterance.onend = function() {
                                currentChunk++;
                                setTimeout(speakNextChunk, 100); // ØªÙˆÙ‚Ù Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
                            };
                            
                            speechSynthesis.speak(chunkUtterance);
                        }
                    }
                    
                    speakNextChunk();
                } else {
                    speechSynthesis.speak(utterance);
                }
            }
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª
        function swapLanguages() {
            const langA = document.getElementById('langA');
            const langB = document.getElementById('langB');
            const tempValue = langA.value;
            langA.value = langB.value;
            langB.value = tempValue;
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ
            updateLanguageBar();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ§Øª
        function updateLanguageBar() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù„Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function showErrorMessage(message) {
            createErrorMessage(message, false, null);
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¹ Ø®ÙŠØ§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        function showErrorMessageWithRetry(message, speaker) {
            createErrorMessage(message, true, speaker);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø­Ø³Ù†Ø©
        function createErrorMessage(message, showRetry, speaker, errorType = 'default') {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚Ø©
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            const errorDiv = document.createElement('div');
            let className = 'error-message';
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
            if (errorType === 'network') {
                className += ' network-error';
            } else if (errorType === 'auto-retry') {
                className += ' auto-retry';
            }
            
            errorDiv.className = className;
            
            let retryButton = '';
            if (showRetry && speaker) {
                retryButton = `<button class="error-retry" onclick="retryListening('${speaker}'); this.parentElement.parentElement.remove();">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>`;
            }
            
            // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
            let icon = 'âš ï¸';
            if (errorType === 'network') {
                icon = 'ğŸŒ';
            } else if (errorType === 'auto-retry') {
                icon = 'ğŸ”„';
            }
            
            errorDiv.innerHTML = `
                <div class="error-content">
                    <span class="error-icon">${icon}</span>
                    <span class="error-text">${message}</span>
                    <div class="error-actions">
                        ${retryButton}
                        <button class="error-close" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                </div>
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (!document.querySelector('#error-styles')) {
                const style = document.createElement('style');
                style.id = 'error-styles';
                style.textContent = `
                    .error-message {
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 1000;
                        background: #ff4757;
                        color: white;
                        padding: 0;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
                        animation: slideDown 0.3s ease-out;
                        max-width: 90%;
                        min-width: 300px;
                    }
                    
                    .error-content {
                        display: flex;
                        align-items: center;
                        padding: 12px 16px;
                        gap: 10px;
                    }
                    
                    .error-icon {
                        font-size: 18px;
                        flex-shrink: 0;
                    }
                    
                    .error-text {
                        flex: 1;
                        font-size: 14px;
                        line-height: 1.4;
                    }
                    
                    .error-actions {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .error-retry {
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 4px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .error-retry:hover {
                        background: rgba(255, 255, 255, 0.3);
                        border-color: rgba(255, 255, 255, 0.5);
                    }
                    
                    /* Ù…Ø¤Ø´Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© */
                    .error-message.auto-retry {
                        background: #ff9500;
                        animation: slideDown 0.3s ease-out, autoRetryPulse 2s infinite;
                    }
                    
                    .error-message.network-error {
                        background: #ff6b6b;
                    }
                    
                    .retry-countdown {
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        font-weight: bold;
                        animation: countdown 1s infinite;
                    }
                    
                    @keyframes autoRetryPulse {
                        0%, 100% { box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3); }
                        50% { box-shadow: 0 4px 20px rgba(255, 149, 0, 0.5); }
                    }
                    
                    @keyframes countdown {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    
                    .error-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s;
                    }
                    
                    .error-close:hover {
                        background-color: rgba(255, 255, 255, 0.2);
                    }
                    
                    @keyframes slideDown {
                        from {
                            transform: translateX(-50%) translateY(-100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(-50%) translateY(0);
                            opacity: 1;
                        }
                    }
                    
                    .dark-mode .error-message {
                        background: #ff3742;
                        box-shadow: 0 4px 12px rgba(255, 55, 66, 0.4);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
            document.body.appendChild(errorDiv);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†Ù (ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©)
            const autoRemoveTime = showRetry ? 8000 : 5000;
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, autoRemoveTime);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        function retryListening(speaker) {
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            setTimeout(() => {
                console.log(`Retrying speech recognition for ${speaker}`);
                startListening(speaker);
            }, 500);
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function saveConversation() {
            if (conversationData.length === 0) {
                showErrorMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø­ÙØ¸Ù‡Ø§');
                return;
            }
            
            const dataStr = JSON.stringify(conversationData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `conversation_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function clearConversation() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) {
                document.getElementById('scrollA').innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’¬</div><div>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</div></div>';
                document.getElementById('scrollB').innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’¬</div><div>Start conversation...</div></div>';
                conversationData = [];
                messageCount = 0;
                translationCount = 0;
                updateStats();
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${messageCount} | Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª: ${translationCount}`;
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        let isOnline = navigator.onLine;
        let lastNetworkError = null;
        let networkRetryAttempts = 0;
        const maxRetryAttempts = 3;
        
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                status.textContent = 'ğŸŸ¢';
                text.textContent = 'Ù…ØªØµÙ„';
                networkRetryAttempts = 0;
            } else {
                indicator.className = 'connection-indicator offline';
                status.textContent = 'ğŸ”´';
                text.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
            }
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', function() {
            isOnline = true;
            updateConnectionStatus();
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ Ø´Ø¨ÙƒØ© Ø³Ø§Ø¨Ù‚
            if (lastNetworkError && lastNetworkError.speaker) {
                setTimeout(() => {
                    showErrorMessageWithRetry('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©ØŸ', lastNetworkError.speaker);
                    lastNetworkError = null;
                }, 1000);
            }
        });
        
        window.addEventListener('offline', function() {
            isOnline = false;
            updateConnectionStatus();
            showErrorMessage('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.');
        });
        
        // ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©
        function handleNetworkError(speaker) {
            const timestamp = Date.now();
            lastNetworkError = { speaker, timestamp };
            
            // ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ù„Ø®Ø·Ø£
            console.warn('Speech Recognition Network Error:', {
                speaker: speaker,
                timestamp: new Date(timestamp).toISOString(),
                isOnline: isOnline,
                retryAttempts: networkRetryAttempts,
                userAgent: navigator.userAgent,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'unknown'
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            if (!isOnline) {
                createErrorMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.', false, null, 'network');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showErrorMessage('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                return;
            }
            
            networkRetryAttempts++;
            
            if (networkRetryAttempts <= maxRetryAttempts) {
                // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù…ØªØ¯Ø±Ø¬
                const retryDelay = Math.min(1000 * Math.pow(2, networkRetryAttempts - 1), 8000); // ØªØ£Ø®ÙŠØ± Ù…ØªØ¯Ø±Ø¬: 1s, 2s, 4s, 8s
                const retryMessage = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${networkRetryAttempts}/${maxRetryAttempts}). <span class="retry-countdown">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ù„Ø§Ù„ ${Math.ceil(retryDelay/1000)} Ø«Ø§Ù†ÙŠØ©... â±ï¸</span>`;
                
                createErrorMessage(retryMessage, false, null, 'auto-retry');
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                setTimeout(() => {
                    console.log(`Auto-retrying speech recognition for ${speaker} (attempt ${networkRetryAttempts})`);
                    retryListening(speaker);
                }, retryDelay);
            } else {
                const finalMessage = `ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯ ${maxRetryAttempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.`;
                createErrorMessage(finalMessage, true, speaker, 'network');
                networkRetryAttempts = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateConnectionStatus();

        // Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        class ConversationModeManager {
            constructor() {
                this.currentMode = 'face-to-face';
                this.isRecording = false;
                this.chatMessages = [];
                this.currentUser = null;
                this.connectedUsers = new Map();
                this.init();
            }

            init() {
                this.checkUserAuthentication();
                this.setupModeButtons();
                this.setupRemoteChat();
                this.updateUI();
                this.updateLanguageSettings();
                this.updateModeButtons();
            }

            setupModeButtons() {
                const faceToFaceBtn = document.getElementById('faceToFaceMode');
                const remoteBtn = document.getElementById('remoteMode');

                faceToFaceBtn?.addEventListener('click', () => this.switchMode('face-to-face'));
                remoteBtn?.addEventListener('click', () => this.switchMode('remote'));
            }

            setupRemoteChat() {
                const sendBtn = document.getElementById('sendBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                const chatInput = document.getElementById('chatInput');
                const myLanguageSelect = document.getElementById('myLanguageRemote');
                const targetLanguageSelect = document.getElementById('targetLanguageRemote');
                const langSwapBtn = document.getElementById('langSwapRemote');

                sendBtn?.addEventListener('click', () => this.sendMessage());
                voiceBtn?.addEventListener('click', () => this.toggleVoiceRecording());
                chatInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
                myLanguageSelect?.addEventListener('change', () => this.updateLanguageSettings());
                targetLanguageSelect?.addEventListener('change', () => this.updateLanguageSettings());
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
                langSwapBtn?.addEventListener('click', () => this.swapLanguages());
            }
            
            updateLanguageSettings() {
                const myLang = document.getElementById('myLanguageRemote')?.value;
                const targetLang = document.getElementById('targetLanguageRemote')?.value;
                
                // ØªØ­Ø¯ÙŠØ« placeholder Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    const placeholders = {
                        'ar': 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...',
                        'en': 'Type your message here...',
                        'fr': 'Tapez votre message ici...',
                        'es': 'Escribe tu mensaje aquÃ­...',
                        'de': 'Geben Sie Ihre Nachricht hier ein...',
                        'it': 'Digita il tuo messaggio qui...',
                        'pt': 'Digite sua mensagem aqui...',
                        'ru': 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ·Ğ´ĞµÑÑŒ...',
                        'ja': 'ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
                        'ko': 'ì—¬ê¸°ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
                        'zh': 'åœ¨æ­¤è¾“å…¥æ‚¨çš„æ¶ˆæ¯...'
                    };
                    chatInput.placeholder = placeholders[myLang] || placeholders['ar'];
                    chatInput.dir = ['ar'].includes(myLang) ? 'rtl' : 'ltr';
                }
                
                console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ§Øª: Ù„ØºØªÙŠ ${myLang} -> Ù„ØºØ© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ${targetLang}`);
            }
            
            swapLanguages() {
                const myLanguageSelect = document.getElementById('myLanguageRemote');
                const targetLanguageSelect = document.getElementById('targetLanguageRemote');
                
                if (myLanguageSelect && targetLanguageSelect) {
                    // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    const myLang = myLanguageSelect.value;
                    const targetLang = targetLanguageSelect.value;
                    
                    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…
                    myLanguageSelect.value = targetLang;
                    targetLanguageSelect.value = myLang;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    this.updateLanguageSettings();
                    
                    console.log(`ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª: ${myLang} â†” ${targetLang}`);
                }
            }

            checkUserAuthentication() {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
                const guestSession = localStorage.getItem('guest_session');
                
                if (userSession) {
                    try {
                        const userData = JSON.parse(userSession);
                        if (userData.isLoggedIn) {
                            this.currentUser = userData;
                            console.log('Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„:', userData.email);
                            return;
                        }
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                    }
                }
                
                if (guestSession) {
                    try {
                        const guestData = JSON.parse(guestSession);
                        this.currentUser = { ...guestData, isGuest: true };
                        console.log('Ø¬Ù„Ø³Ø© Ø¶ÙŠÙ Ù†Ø´Ø·Ø©:', guestData.sessionId);
                        return;
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ø¶ÙŠÙ:', error);
                    }
                }
                
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©');
            }

            switchMode(mode) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù„ÙˆØ¶Ø¹ Remote
                if (mode === 'remote' && !this.currentUser) {
                    this.showAuthenticationRequired();
                    return;
                }
                
                this.currentMode = mode;
                this.updateUI();
                this.updateModeButtons();
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ remote ÙˆÙ‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ØŒ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (mode === 'remote' && this.currentUser) {
                    this.updateRemoteChatForAuthenticatedUser();
                }
            }

            updateModeButtons() {
                const faceToFaceBtn = document.getElementById('faceToFaceMode');
                const remoteBtn = document.getElementById('remoteMode');

                faceToFaceBtn?.classList.toggle('active', this.currentMode === 'face-to-face');
                remoteBtn?.classList.toggle('active', this.currentMode === 'remote');
            }

            updateUI() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                const conversationPanes = document.getElementById('conversationPanes');

                if (this.currentMode === 'remote') {
                    remoteChatContainer?.classList.add('active');
                    conversationPanes?.style.setProperty('display', 'none');
                    conversationPanes?.classList.remove('face-to-face');
                } else {
                    remoteChatContainer?.classList.remove('active');
                    conversationPanes?.style.setProperty('display', 'grid');
                    conversationPanes?.classList.remove('remote');
                    conversationPanes?.classList.add('face-to-face');
                }
            }

            showAuthenticationRequired() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (remoteChatContainer) {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    const authMessage = document.createElement('div');
                    authMessage.className = 'auth-required-message';
                    authMessage.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; margin: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ”</div>
                            <h3 style="color: var(--brand-primary); margin-bottom: 12px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h3>
                            <p style="color: #64748b; margin-bottom: 20px;">Ù„Ù„ØªØ­Ø¯Ø« Ø¹Ù† Ø¨ÙØ¹Ø¯ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</p>
                            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="window.location.href='login.html'" style="background: var(--brand-primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                                <button onclick="conversationModeManager.switchMode('face-to-face')" style="background: #e2e8f0; color: #475569; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ</button>
                            </div>
                        </div>
                    `;
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©
                    const existingMessage = remoteChatContainer.querySelector('.auth-required-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    
                    remoteChatContainer.appendChild(authMessage);
                    remoteChatContainer.classList.add('active');
                }
            }

            updateRemoteChatForAuthenticatedUser() {
                const remoteConnectionStatus = document.getElementById('remoteConnectionStatus');
                const remoteChatTitle = document.querySelector('.remote-chat-title');
                
                if (remoteConnectionStatus && this.currentUser) {
                    if (this.currentUser.isGuest) {
                        remoteConnectionStatus.innerHTML = `
                            <span>ğŸ‘¤</span>
                            <span>Ø¶ÙŠÙ - ${this.currentUser.sessionId?.substring(0, 8) || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                        `;
                    } else {
                        remoteConnectionStatus.innerHTML = `
                            <span>âœ…</span>
                            <span>Ù…Ø³Ø¬Ù„ - ${this.currentUser.email || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                        `;
                    }
                }
                
                if (remoteChatTitle) {
                    remoteChatTitle.textContent = this.currentUser.isGuest ? 
                        'ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯ (Ø¶ÙŠÙ)' : 
                        'ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯ (Ù…Ø³Ø¬Ù„)';
                }
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
                const authMessage = document.querySelector('.auth-required-message');
                if (authMessage) {
                    authMessage.remove();
                }
                
                // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                this.showUserMatchingInterface();
            }

            async sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput?.value.trim();

                if (!message) return;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©
                this.addChatBubble(message, 'sent');
                chatInput.value = '';

                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„Ø±Ø¯
                try {
                    const translatedMessage = await this.translateMessage(message);
                    
                    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ± Ø§Ù„Ø´Ø¨ÙƒØ©
                    setTimeout(() => {
                        this.addChatBubble(translatedMessage, 'received', message);
                    }, 1000 + Math.random() * 2000);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                }
            }

            async translateMessage(text) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ØºØ© Ù…Ù† Remote mode
                const fromLang = document.getElementById('myLanguageRemote')?.value || 'ar';
                const toLang = document.getElementById('targetLanguageRemote')?.value || 'en';
                
                try {
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`);
                    const data = await response.json();
                    return data.responseData?.translatedText || text;
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                    return `[ØªØ±Ø¬Ù…Ø©] ${text}`;
                }
            }

            addChatBubble(message, type, originalText = null) {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;

                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${type}`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let content = `<div class="bubble-content">`;
                
                if (type === 'received' && originalText) {
                    content += `<div class="bubble-original">${originalText}</div>`;
                    content += `<div class="bubble-translation">${message}</div>`;
                } else {
                    content += `<div class="bubble-original">${message}</div>`;
                }
                
                content += `</div><div class="bubble-time">${timeStr}</div>`;
                bubble.innerHTML = content;

                chatMessages.appendChild(bubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                this.chatMessages.push({
                    message,
                    type,
                    originalText,
                    timestamp: now.toISOString()
                });
            }

            // Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            async findAvailableUsers() {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†
                const availableUsers = [
                    { id: 'user1', name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', status: 'online', language: 'ar' },
                    { id: 'user2', name: 'Sarah Johnson', status: 'online', language: 'en' },
                    { id: 'user3', name: 'Marie Dubois', status: 'online', language: 'fr' },
                    { id: 'user4', name: 'Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', status: 'online', language: 'ar' }
                ];
                
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)
                return availableUsers.filter(user => 
                    user.id !== this.currentUser?.id && 
                    user.status === 'online'
                );
            }

            showUserMatchingInterface() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (!remoteChatContainer) return;
                
                const matchingInterface = document.createElement('div');
                matchingInterface.className = 'user-matching-interface';
                matchingInterface.innerHTML = `
                    <div style="padding: 20px; background: white; border-radius: 12px; margin: 20px;">
                        <h3 style="color: var(--brand-primary); margin-bottom: 16px; text-align: center;">ğŸŒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                        

                        
                        <div id="usersList" style="display: none;"></div>
                        <div id="searchingIndicator" style="display: none; text-align: center; padding: 20px;">
                            <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ”</div>
                            <p style="color: #64748b;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ†...</p>
                        </div>
                    </div>
                `;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø§Ø¨Ù‚Ø©
                const existingInterface = remoteChatContainer.querySelector('.user-matching-interface');
                if (existingInterface) {
                    existingInterface.remove();
                }
                
                remoteChatContainer.appendChild(matchingInterface);
            }

            async showAvailableUsers() {
                const usersList = document.getElementById('usersList');
                const searchingIndicator = document.getElementById('searchingIndicator');
                
                if (!usersList || !searchingIndicator) return;
                
                searchingIndicator.style.display = 'block';
                usersList.style.display = 'none';
                
                try {
                    const users = await this.findAvailableUsers();
                    
                    setTimeout(() => {
                        searchingIndicator.style.display = 'none';
                        
                        if (users.length === 0) {
                            usersList.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: #64748b;">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ˜”</div>
                                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                </div>
                            `;
                        } else {
                            usersList.innerHTML = `
                                <h4 style="margin-bottom: 12px; color: var(--brand-text);">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†:</h4>
                                ${users.map(user => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--brand-text);">${user.name}</div>
                                            <div style="font-size: 0.85rem; color: #64748b;">ğŸŒ ${this.getLanguageName(user.language)}</div>
                                        </div>
                                        <button onclick="conversationModeManager.connectToUser('${user.id}', '${user.name}')" style="background: var(--brand-primary); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Ø§ØªØµØ§Ù„</button>
                                    </div>
                                `).join('')}
                            `;
                        }
                        
                        usersList.style.display = 'block';
                    }, 1500);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                    searchingIndicator.style.display = 'none';
                    usersList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ef4444;">
                            <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                        </div>
                    `;
                    usersList.style.display = 'block';
                }
            }

            async findRandomUser() {
                const searchingIndicator = document.getElementById('searchingIndicator');
                if (searchingIndicator) {
                    searchingIndicator.style.display = 'block';
                    searchingIndicator.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ²</div>
                        <p style="color: #64748b;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©...</p>
                    `;
                }
                
                try {
                    const users = await this.findAvailableUsers();
                    
                    setTimeout(() => {
                        if (users.length > 0) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            this.connectToUser(randomUser.id, randomUser.name);
                        } else {
                            if (searchingIndicator) {
                                searchingIndicator.innerHTML = `
                                    <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ˜”</div>
                                    <p style="color: #64748b;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</p>
                                `;
                            }
                        }
                    }, 2000);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ:', error);
                }
            }

            connectToUser(userId, userName) {
                console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userName} (${userId})`);
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (remoteChatContainer) {
                    const connectionInterface = document.createElement('div');
                    connectionInterface.className = 'connection-interface';
                    connectionInterface.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: #f0f9ff; border-radius: 12px; margin: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“</div>
                            <h3 style="color: var(--brand-primary); margin-bottom: 12px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
                            <p style="color: #64748b; margin-bottom: 20px;">Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${userName}</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="conversationModeManager.simulateConnection('${userId}', '${userName}')" style="background: var(--brand-secondary); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§ØªØµØ§Ù„</button>
                            <button onclick="conversationModeManager.cancelConnection()" style="background: #ef4444; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </div>
                    `;
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø³Ø§Ø¨Ù‚Ø©
                    const existingInterface = remoteChatContainer.querySelector('.user-matching-interface, .connection-interface');
                    if (existingInterface) {
                        existingInterface.remove();
                    }
                    
                    remoteChatContainer.appendChild(connectionInterface);
                }
            }

            simulateConnection(userId, userName) {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­
                this.connectedUsers.set(userId, { name: userName, status: 'connected' });
                
                // Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                const connectionInterface = document.querySelector('.connection-interface');
                if (connectionInterface) {
                    connectionInterface.remove();
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                this.updateRemoteChatForConnectedUser(userName);
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
                setTimeout(() => {
                    this.addChatBubble(`Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ ${userName}`, 'received');
                }, 1000);
            }

            cancelConnection() {
                const connectionInterface = document.querySelector('.connection-interface');
                if (connectionInterface) {
                    connectionInterface.remove();
                }
                this.showUserMatchingInterface();
            }

            updateRemoteChatForConnectedUser(userName) {
                const remoteConnectionStatus = document.getElementById('remoteConnectionStatus');
                const remoteChatTitle = document.querySelector('.remote-chat-title');
                
                if (remoteConnectionStatus) {
                    remoteConnectionStatus.innerHTML = `
                        <span>ğŸŸ¢</span>
                        <span>Ù…ØªØµÙ„ Ù…Ø¹ ${userName}</span>
                    `;
                }
                
                if (remoteChatTitle) {
                    remoteChatTitle.textContent = `ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${userName}`;
                }
            }

            getLanguageName(langCode) {
                const languages = {
                    'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                    'en': 'English',
                    'fr': 'FranÃ§ais',
                    'es': 'EspaÃ±ol',
                    'de': 'Deutsch'
                };
                return languages[langCode] || langCode;
            }

            toggleVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                if (this.isRecording) {
                    this.stopVoiceRecording();
                } else {
                    this.startVoiceRecording();
                }
            }

            startVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                this.isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = 'â¹ï¸';

                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = document.getElementById('langA')?.value === 'ar' ? 'ar-SA' : 'en-US';
                    recognition.continuous = false;
                    recognition.interimResults = false;

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        this.stopVoiceRecording();
                    };

                    recognition.onerror = () => {
                        this.stopVoiceRecording();
                    };

                    recognition.start();
                    this.currentRecognition = recognition;
                } else {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
                    setTimeout(() => {
                        document.getElementById('chatInput').value = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
                        this.stopVoiceRecording();
                    }, 2000);
                }
            }

            stopVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                this.isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = 'ğŸ¤';

                if (this.currentRecognition) {
                    this.currentRecognition.stop();
                    this.currentRecognition = null;
                }
            }

            // Ø¯Ù…Ø¬ Ù…Ø¹ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            saveConversation() {
                if (this.currentMode === 'remote') {
                    const conversationData = {
                        mode: 'remote',
                        messages: this.chatMessages,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('remoteConversation', JSON.stringify(conversationData));
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                    if (typeof saveConversation === 'function') {
                        saveConversation();
                    }
                }
            }

            clearConversation() {
                if (this.currentMode === 'remote') {
                    this.chatMessages = [];
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                    }
                    localStorage.removeItem('remoteConversation');
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                    if (typeof clearConversation === 'function') {
                        clearConversation();
                    }
                }
            }
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© Ù„ÙˆØ¶Ø¹ ÙˆØ¬Ù‡Ø§Ù‹ Ù„ÙˆØ¬Ù‡
        class DualMicrophoneManager {
            constructor() {
                this.currentSpeaker = null;
                this.recognition = null;
                this.isListening = false;
                this.conversations = { a: [], b: [] };
                this.lastAudioText = { a: '', b: '' };
                
                this.initializeMicrophones();
            }

            initializeMicrophones() {
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.updateMicrophoneUI();
                    };
                    
                    this.recognition.onresult = (event) => {
                        const text = event.results[0][0].transcript;
                        this.handleSpeechResult(text);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:', event.error);
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
                
                // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                document.getElementById('micA')?.addEventListener('click', () => this.startListening('a'));
                document.getElementById('micB')?.addEventListener('click', () => this.startListening('b'));
                
                // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
                document.getElementById('playA')?.addEventListener('click', () => this.playAudio('a'));
                document.getElementById('playB')?.addEventListener('click', () => this.playAudio('b'));
            }

            startListening(speaker) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ÙˆØ¬Ù‡Ø§Ù‹ Ù„ÙˆØ¬Ù‡
                if (conversationModeManager && conversationModeManager.currentMode !== 'face-to-face') {
                    return;
                }
                
                if (!this.recognition) {
                    alert('Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                    return;
                }
                
                if (this.isListening) {
                    this.stopListening();
                    return;
                }
                
                this.currentSpeaker = speaker;
                const langSelect = document.getElementById(`lang${speaker.toUpperCase()}`);
                const selectedLang = langSelect?.value || 'ar';
                
                this.recognition.lang = this.getRecognitionLanguage(selectedLang);
                this.recognition.start();
            }

            stopListening() {
                this.isListening = false;
                this.currentSpeaker = null;
                this.updateMicrophoneUI();
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            updateMicrophoneUI() {
                const micA = document.getElementById('micA');
                const micB = document.getElementById('micB');
                
                [micA, micB].forEach(mic => {
                    if (mic) {
                        const speaker = mic.dataset.speaker;
                        const isActive = this.isListening && this.currentSpeaker === speaker;
                        
                        mic.classList.toggle('listening', isActive);
                        const micText = mic.querySelector('.mic-text');
                        if (micText) {
                            if (isActive) {
                                micText.textContent = speaker === 'a' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...' : 'Listening...';
                            } else {
                                micText.textContent = speaker === 'a' ? 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«' : 'Click to speak';
                            }
                        }
                    }
                });
            }

            async handleSpeechResult(text) {
                if (!this.currentSpeaker) return;
                
                const speaker = this.currentSpeaker;
                const otherSpeaker = speaker === 'a' ? 'b' : 'a';
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
                this.addMessageToPane(speaker, text, 'original');
                
                // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ
                const translatedText = await this.translateText(text, speaker, otherSpeaker);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                this.addMessageToPane(otherSpeaker, translatedText, 'translation', text);
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
                this.lastAudioText[otherSpeaker] = translatedText;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
                const playBtn = document.getElementById(`play${otherSpeaker.toUpperCase()}`);
                if (playBtn) {
                    playBtn.style.display = 'block';
                }
                
                this.stopListening();
            }

            async translateText(text, fromSpeaker, toSpeaker) {
                const fromLang = document.getElementById(`lang${fromSpeaker.toUpperCase()}`)?.value || 'ar';
                const toLang = document.getElementById(`lang${toSpeaker.toUpperCase()}`)?.value || 'en';
                
                try {
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`);
                    const data = await response.json();
                    return data.responseData?.translatedText || text;
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                    return `[ØªØ±Ø¬Ù…Ø©] ${text}`;
                }
            }

            addMessageToPane(speaker, text, type, originalText = null) {
                const scroll = document.getElementById(`scroll${speaker.toUpperCase()}`);
                if (!scroll) return;
                
                // Ø¥Ø²Ø§Ù„Ø© empty state Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                const emptyState = scroll.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let content = `<div class="message-content">`;
                
                if (type === 'translation' && originalText) {
                    content += `<div class="original-text">${originalText}</div>`;
                    content += `<div class="translated-text">${text}</div>`;
                } else {
                    content += `<div class="message-text">${text}</div>`;
                }
                
                content += `</div><div class="message-time">${timeStr}</div>`;
                messageDiv.innerHTML = content;
                
                scroll.appendChild(messageDiv);
                scroll.scrollTop = scroll.scrollHeight;
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                this.conversations[speaker].push({
                    text,
                    type,
                    originalText,
                    timestamp: now.toISOString()
                });
            }

            async playAudio(speaker) {
                const text = this.lastAudioText[speaker];
                if (!text) return;
                
                const lang = document.getElementById(`lang${speaker.toUpperCase()}`)?.value || 'ar';
                
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.getTTSLanguage(lang);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
                }
            }

            getRecognitionLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL',
                    'sv': 'sv-SE'
                };
                return langMap[langCode] || 'ar-SA';
            }

            getTTSLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL',
                    'sv': 'sv-SE'
                };
                return langMap[langCode] || 'ar-SA';
            }
        }

        // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯
        class RemoteTranslationManager {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª
                const langSwapBtn = document.getElementById('langSwapBtn');
                if (langSwapBtn) {
                    langSwapBtn.addEventListener('click', () => {
                        this.swapLanguages();
                    });
                }

                // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØµÙˆØª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯
                const sendBtn = document.getElementById('sendBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                const chatInput = document.getElementById('chatInput');

                if (sendBtn) {
                    sendBtn.addEventListener('click', () => {
                        this.sendMessage();
                    });
                }

                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                }

                if (voiceBtn) {
                    voiceBtn.addEventListener('click', () => {
                        this.toggleVoiceRecording();
                    });
                }
            }

            swapLanguages() {
                const speakerLang = document.getElementById('speakerLang');
                const receiverLang = document.getElementById('receiverLang');
                
                if (speakerLang && receiverLang) {
                    const temp = speakerLang.value;
                    speakerLang.value = receiverLang.value;
                    receiverLang.value = temp;
                }
            }

            async sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                this.addChatMessage(message, 'sent', false);
                
                // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                await this.translateAndSend(message);
                
                // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                chatInput.value = '';
            }

            async translateAndSend(message) {
                const speakerLang = document.getElementById('speakerLang')?.value || 'ar';
                const receiverLang = document.getElementById('receiverLang')?.value || 'en';
                
                if (speakerLang !== receiverLang) {
                    try {
                        const translation = await this.translateText(message, speakerLang, receiverLang);
                        this.addChatMessage(translation, 'sent', true, message);
                        
                        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© ØµÙˆØªÙŠØ§Ù‹
                        setTimeout(() => {
                            this.speakText(translation, receiverLang);
                        }, 500);
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                        this.addChatMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©', 'sent', true, message);
                    }
                }
            }

            async translateText(text, from, to) {
                try {
                    if (!text || text.trim().length === 0) {
                        return 'Ø§Ù„Ù†Øµ ÙØ§Ø±Øº';
                    }

                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`);
                    const data = await response.json();
                    
                    if (data.responseStatus === 200) {
                        return data.responseData.translatedText;
                    } else {
                        return `ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©: ${data.responseDetails || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©:', error);
                    return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                }
            }

            addChatMessage(text, type, isTranslation = false, originalText = '') {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}`;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let content = `<div class="message-content">`;
                
                if (isTranslation && originalText) {
                    content += `<div class="original-text" style="font-size: 0.85em; opacity: 0.7; margin-bottom: 4px;">${originalText}</div>`;
                    content += `<div class="translated-text" style="font-weight: 600;">${text}</div>`;
                } else {
                    content += `<div class="message-text">${text}</div>`;
                }
                
                content += `</div><div class="message-time" style="font-size: 0.75em; opacity: 0.6; margin-top: 4px;">${timeStr}</div>`;
                messageDiv.innerHTML = content;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async speakText(text, lang) {
                if (!text || !('speechSynthesis' in window)) return;
                
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.getTTSLanguage(lang);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
                }
            }

            getTTSLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL'
                };
                return langMap[langCode] || 'ar-SA';
            }

            toggleVoiceRecording() {
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù† Ø¨ÙØ¹Ø¯
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª');
                    return;
                }

                const voiceBtn = document.getElementById('voiceBtn');
                const speakerLang = document.getElementById('speakerLang')?.value || 'ar';
                
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording(speakerLang, voiceBtn);
                }
            }

            startRecording(lang, button) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.lang = this.getRecognitionLanguage(lang);
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                
                this.recognition.onstart = () => {
                    this.isRecording = true;
                    button.style.background = '#ef4444';
                    button.innerHTML = 'â¹ï¸';
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = transcript;
                        this.sendMessage();
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:', event.error);
                    this.stopRecording();
                };
                
                this.recognition.onend = () => {
                    this.stopRecording();
                };
                
                this.recognition.start();
            }

            stopRecording() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                this.isRecording = false;
                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.style.background = '';
                    voiceBtn.innerHTML = 'ğŸ¤';
                }
            }

            getRecognitionLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL'
                };
                return langMap[langCode] || 'ar-SA';
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡
        let conversationModeManager;
        let dualMicrophoneManager;
        let remoteTranslationManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            conversationModeManager = new ConversationModeManager();
            dualMicrophoneManager = new DualMicrophoneManager();
            remoteTranslationManager = new RemoteTranslationManager();
            
            // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø³Ø­ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const saveBtn = document.getElementById('saveChat');
            const clearBtn = document.getElementById('clearChat');
            
            saveBtn?.addEventListener('click', () => {
                conversationModeManager.saveConversation();
            });
            
            clearBtn?.addEventListener('click', () => {
                conversationModeManager.clearConversation();
            });
        });
    </script>
</body>
</html>