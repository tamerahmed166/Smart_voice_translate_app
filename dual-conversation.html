<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محادثة ثنائية محسنة - مترجم صوتي</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* الألوان الأساسية للعلامة التجارية */
            --brand-bg: #ffffff;
            --brand-text: #0f172a;
            --brand-muted: #64748b;
            --brand-primary: #3b82f6;
            --brand-primary-soft: #eff6ff;
            --brand-secondary: #10b981;
            --brand-secondary-soft: #ecfdf5;
            --panel-radius: 18px;
            --bubble-radius: 14px;
            --shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
            
            /* ألوان المتحدثين */
            --person1-color: #3b82f6;
            --person2-color: #10b981;
            --person1-bg: #eff6ff;
            --person2-bg: #ecfdf5;
        }
        
        /* للهواتف المحمولة الصغيرة جداً */
        @media (max-width: 480px) {
            .top-menu {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
                padding: 6px 8px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: auto;
            }
            
            .app-logo {
                height: 30px;
            }
            
            .langbar {
                padding: 6px 10px;
                gap: 8px;
                font-size: 0.8rem;
            }
            
            .lang-section {
                gap: 4px;
            }
            
            .swapbtn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .connection-indicator {
                font-size: 10px;
                padding: 2px 6px;
            }
        }
        
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            color: var(--brand-text);
            background: var(--brand-bg);
            direction: rtl;
        }
        
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            gap: 14px;
        }
        
        /* شريط اللغات */
        .langbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: white;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .connection-indicator.online {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .connection-indicator.offline {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .connection-status {
            font-size: 14px;
        }
        
        .lang-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .lang-section.left { justify-content: flex-start; }
        .lang-section.right { justify-content: flex-end; }
        
        .flag { font-size: 1.5rem; }
        
        .swapbtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2rem;
            min-width: 48px;
            min-height: 48px;
        }
        
        .swapbtn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .swapbtn:active { transform: scale(0.96); }
        
        /* القائمة العلوية */
        .top-menu {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: white;
            border-radius: 14px;
            box-shadow: var(--shadow);
            margin-bottom: 12px;
        }
        
        /* قسم اللوجو */
        .logo-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            margin-bottom: 12px;
        }
        
        .app-logo {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            min-width: 100px;
            min-height: 44px;
        }
        
        .btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
        }
        
        .btn:active { transform: scale(0.96); }
        
        .btn.save { background: var(--brand-primary); color: white; }
        .btn.clear { background: #ef4444; color: white; }
        .btn.dark { background: #374151; color: white; }
        .btn.home { background: var(--brand-secondary); color: white; }
        
        /* أزرار تبديل الأوضاع */
        .mode-switcher {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        
        .mode-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 18px 28px;
            border-radius: 16px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--brand-primary);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: white;
            border-color: var(--brand-primary);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .mode-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }
        
        .mode-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }
        
        .mode-text {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .mode-desc {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .mode-btn.active .mode-desc {
            opacity: 0.9;
        }
        
        /* لوحات المحادثة */
        .panes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* وضع Face-to-Face */
        .panes.face-to-face {
            grid-template-columns: 1fr 1fr;
        }
        
        /* وضع Remote */
        .panes.remote {
            grid-template-columns: 1fr;
        }
        
        .remote-chat-container {
            display: none;
            background: white;
            border-radius: var(--panel-radius);
            box-shadow: var(--shadow);
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .remote-chat-container.active {
            display: block;
        }
        
        .remote-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .remote-chat-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--brand-primary);
        }
        
        .connection-status-remote {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--brand-secondary-soft);
            color: var(--brand-secondary);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .remote-language-selector {
            display: flex;
            align-items: end;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .language-option {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .lang-swap-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
            margin-bottom: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 48px;
            min-height: 48px;
        }
        
        .lang-swap-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .lang-swap-btn:active {
            transform: scale(0.95);
        }
        
        .language-option label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--brand-text);
        }
        
        .lang-select-remote {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: var(--brand-text);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .lang-select-remote:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .lang-select-remote:hover {
            border-color: var(--brand-primary);
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: slideInChat 0.3s ease;
        }
        
        .chat-bubble.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--brand-primary), #2563eb);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .chat-bubble.received {
            align-self: flex-start;
            background: white;
            color: var(--brand-text);
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }
        
        .bubble-content {
            margin-bottom: 4px;
        }
        
        .bubble-original {
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .bubble-translation {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .bubble-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: left;
        }
        
        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: var(--brand-primary);
        }
        
        .send-btn, .voice-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            min-width: 52px;
            min-height: 52px;
        }
        
        .send-btn {
            background: var(--brand-primary);
            color: white;
        }
        
        .send-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .voice-btn {
            background: var(--brand-secondary);
            color: white;
        }
        
        .voice-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        .voice-btn.recording {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes slideInChat {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pane {
            border-radius: var(--panel-radius);
            padding: 16px;
            min-height: 40vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 12px;
            box-shadow: var(--shadow);
            background: #fff;
            border: 2px solid #eef2f7;
            position: relative;
            min-width: 300px;
        }
        
        .pane.a {
            background: var(--brand-primary-soft);
            border-color: var(--brand-primary);
        }
        
        .pane.b {
            background: var(--brand-secondary-soft);
            border-color: var(--brand-secondary);
        }
        
        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pane-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .pane.a .pane-title { color: var(--brand-primary); }
        .pane.b .pane-title { color: var(--brand-secondary); }
        
        .lang-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 0.9rem;
        }
        
        /* منطقة المحادثة */
        .scroll {
            overflow: auto;
            display: grid;
            gap: 10px;
            align-content: start;
            padding: 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            min-height: 200px;
        }
        
        /* حالة فارغة */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: #64748b;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.7;
        }
        
        .empty-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* أنماط الرسائل */
        .message {
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            animation: slideInMessage 0.3s ease-out;
        }
        
        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.original {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
        }
        
        .message.translation {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-left: 4px solid #9c27b0;
        }
        
        .message-content {
            margin-bottom: 4px;
        }
        
        .message-text {
            font-size: 1rem;
            line-height: 1.4;
            color: #333;
        }
        
        .original-text {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            font-style: italic;
        }
        
        .translated-text {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #888;
            text-align: right;
        }
        
        /* أنماط التحكم */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .mic-btn, .play-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .mic-btn {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            flex: 1;
            min-width: 120px;
            min-height: 60px;
        }
        
        .mic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .mic-btn.listening {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .play-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            min-width: 120px;
            min-height: 60px;
            color: white;
        }
        
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .mic-icon, .play-icon {
            font-size: 1.2rem;
        }
        
        .mic-text {
            font-size: 0.8rem;
            text-align: center;
        }
        
        /* تحسينات الشاشات الصغيرة */
        @media (max-width: 768px) {
            .panes {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .pane {
                min-height: 30vh;
            }
            
            .pane-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .mic-btn {
                width: 100%;
            }
        }
            background: rgba(255, 255, 255, 0.7);






        .scroll {
            background: rgba(255,255,255,0.7);
        }
        
        .message-group {
            display: grid;
            gap: 4px;
            max-width: 80%;
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .message-group.me { justify-self: end; }
        .message-group.them { justify-self: start; }
        
        .bubble {
            padding: 10px 14px;
            border-radius: var(--bubble-radius);
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bubble.original {
            font-weight: 600;
            border-left: 4px solid var(--brand-primary);
        }
        
        .bubble.translation {
            font-size: 0.92rem;
            color: var(--brand-muted);
            background: #f8fafc;
            border-left: 4px solid var(--brand-secondary);
        }
        
        .message-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .action-btn {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            background: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.2);
        }
        
        /* أزرار التحكم */
        .controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        
        .mic {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid #cbd5e1;
            background: #fff;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .mic:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .mic[data-state="listening"] {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background: var(--brand-primary-soft);
        }
        
        .mic-icon {
            font-size: 1.5rem;
        }
        
        .mic-text {
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 999px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }
        
        /* موجات الصوت */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .voice-wave.active { opacity: 1; }
        
        .wave-bar {
            width: 3px;
            background: currentColor;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; height: 10px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 20px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 15px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 10px; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* التذييل */
        .footer {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            position: sticky;
            bottom: 8px;
            margin-top: 16px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .hands-free {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hands-free:hover {
            color: var(--brand-primary);
        }
        
        .hands-free.active {
            background: var(--brand-primary);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .hands-free.active::before {
            content: '🤖';
            margin-right: 4px;
        }
        
        /* الوضع الليلي */
        .dark-mode {
            --brand-bg: #111827;
            --brand-text: #f9fafb;
            --brand-muted: #9ca3af;
            --brand-primary-soft: #1e3a8a;
            --brand-secondary-soft: #065f46;
        }
        
        .dark-mode .pane,
        .dark-mode .header-controls,
        .dark-mode .footer {
            background: #1f2937;
            border-color: #374151;
        }
        
        .dark-mode .bubble {
            background: #374151;
            color: #f9fafb;
        }
        
        .dark-mode .bubble.translation {
            background: #4b5563;
        }
        
        .dark-mode .header h1 {
            color: #f9fafb;
        }
        
        .dark-mode .controls button {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .controls button:hover {
            background: #4b5563;
        }
        
        .dark-mode .controls button.active {
            background: var(--brand-primary);
            color: white;
        }
        
        .dark-mode .hands-free {
            color: #d1d5db;
        }
        
        .dark-mode .hands-free:hover {
            color: var(--brand-primary);
        }
        
        .dark-mode .connection-indicator {
            background: #374151;
            border-color: #4b5563;
        }
        
        .dark-mode .connection-status.online {
            color: #10b981;
        }
        
        .dark-mode .connection-status.offline {
            color: #ef4444;
        }
        
        .dark-mode .connection-status {
            color: #d1d5db;
        }
        
        .dark-mode #stats {
            color: #9ca3af;
        }
        
        .dark-mode .mic-text {
            color: #d1d5db;
        }
        
        .dark-mode .btn {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .btn:hover {
            background: #4b5563;
        }
        
        .dark-mode .btn.dark {
            background: #1f2937;
            color: #f9fafb;
        }
        
        .dark-mode .btn.dark:hover {
            background: #374151;
        }
        
        .dark-mode select {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode select:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dark-mode .message-actions button {
            background: #4b5563;
            color: #d1d5db;
        }
        
        .dark-mode .message-actions button:hover {
            background: #6b7280;
            color: #f9fafb;
        }
        
        .dark-mode .voice-wave .wave-bar {
            background: currentColor;
        }
        
        .dark-mode .scroll {
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .dark-mode .scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        
        .dark-mode .scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .dark-mode .remote-language-selector {
            background: #1f2937;
            border-color: #374151;
        }
        
        .dark-mode .language-option label {
            color: #f9fafb;
        }
        
        .dark-mode .lang-select-remote {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        
        .dark-mode .lang-select-remote:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dark-mode .lang-select-remote:hover {
            border-color: var(--brand-primary);
        }
        
        .dark-mode .lang-swap-btn {
            background: var(--brand-primary);
            color: white;
        }
        
        .dark-mode .lang-swap-btn:hover {
            background: #2563eb;
        }
        

        

        

        

        

        
        /* التصميم المتجاوب */
        @media (min-width: 1024px) {
            .panes {
                grid-template-columns: 1fr 1fr;
            }
            .pane {
                min-height: 60vh;
            }
        }
        
        @media (max-width: 768px) {
            .wrap {
                padding: 8px;
                gap: 8px;
            }
            
            .top-menu {
                padding: 8px 12px;
                gap: 8px;
                margin-bottom: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                gap: 4px;
            }
            
            .btn span {
                font-size: 0.9rem;
            }
            
            .logo-section {
                padding: 4px;
                margin-bottom: 8px;
            }
            
            .app-logo {
                height: 35px;
            }
            
            .langbar {
                padding: 8px 12px;
                margin-bottom: 12px;
                font-size: 0.85rem;
            }
            
            .swapbtn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .pane {
                padding: 12px;
                min-height: 35vh;
            }
        }

        /* أنماط واجهة ربط المستخدمين */
        .user-matching-interface {
            animation: fadeIn 0.3s ease-in;
        }

        .user-matching-interface button {
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .user-matching-interface button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .connection-interface {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* تحسين أنماط قائمة المستخدمين */
        #usersList {
            max-height: 300px;
            overflow-y: auto;
        }

        #usersList::-webkit-scrollbar {
            width: 6px;
        }

        #usersList::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #usersList::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #usersList::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* تحسين مظهر حالة الاتصال */
        .connection-status-remote {
            transition: all 0.3s ease;
        }

        .connection-status-remote:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="wrap">
        <!-- أزرار القائمة العلوية -->
        <div class="top-menu">
            <button class="btn home" id="homeBtn" title="الصفحة الرئيسية">
                <span>🏠</span>
                الرئيسية
            </button>

            <button class="btn dark" id="darkMode" title="الوضع الليلي">
                <span>🌙</span>
                ليلي
            </button>
            <button class="btn save" id="saveChat" title="حفظ المحادثة">
                <span>💾</span>
                حفظ
            </button>
            <button class="btn clear" id="clearChat" title="مسح المحادثة">
                <span>🗑️</span>
                مسح
            </button>
        </div>
        
        <!-- اللوجو -->
        <div class="logo-section">
            <img src="assets/logo.svg" alt="LingoLink Logo" class="app-logo" style="height: 50px;">
        </div>

        <!-- أزرار التبديل بين الأوضاع -->
        <div class="mode-switcher">
            <button class="mode-btn active" id="faceToFaceMode" data-mode="face-to-face">
                <span class="mode-icon">👥</span>
                <span class="mode-text">وجهاً لوجه</span>
                <span class="mode-desc">Face-to-Face</span>
            </button>
            <button class="mode-btn" id="remoteMode" data-mode="remote">
                <span class="mode-icon">🌐</span>
                <span class="mode-text">عن بُعد</span>
                <span class="mode-desc">Remote</span>
            </button>
        </div>


        
        <!-- واجهة الوضع Remote -->
        <div class="remote-chat-container" id="remoteChatContainer">
            <div class="remote-chat-header">
                <h2 class="remote-chat-title">💬 محادثة عن بُعد</h2>
                <div class="connection-status-remote" id="remoteConnectionStatus">
                    <span>🟢</span>
                    <span>متصل</span>
                </div>
                
                <div class="connection-indicator" id="connectionIndicator">
                    <span class="connection-status" id="connectionStatus">🟢</span>
                    <span id="connectionText">متصل</span>
                </div>
            </div>
            
            <!-- مربع اختيار اللغات للمحادثة عن بُعد -->
            <div class="remote-language-selector" id="remoteLangSelector">
                <div class="language-option">
                    <label for="speakerLang" style="font-size: 0.85rem; font-weight: 600; color: #475569;">لغة المتحدث:</label>
                    <select class="lang-select" id="speakerLang">
                        <option value="ar">العربية 🇪🇬</option>
                        <option value="en">English 🇺🇸</option>
                        <option value="fr">Français 🇫🇷</option>
                        <option value="es">Español 🇪🇸</option>
                        <option value="de">Deutsch 🇩🇪</option>
                        <option value="it">Italiano 🇮🇹</option>
                        <option value="pt">Português 🇵🇹</option>
                        <option value="ru">Русский 🇷🇺</option>
                        <option value="ja">日本語 🇯🇵</option>
                        <option value="ko">한국어 🇰🇷</option>
                        <option value="zh">中文 🇨🇳</option>
                        <option value="hi">हिन्दी 🇮🇳</option>
                        <option value="tr">Türkçe 🇹🇷</option>
                        <option value="nl">Nederlands 🇳🇱</option>
                    </select>
                </div>
                
                <button class="lang-swap-btn" id="langSwapBtn" title="تبديل اللغات">
                    ⇄
                </button>
                
                <div class="language-option">
                    <label for="receiverLang" style="font-size: 0.85rem; font-weight: 600; color: #475569;">لغة المستقبل:</label>
                    <select class="lang-select" id="receiverLang">
                        <option value="en">English 🇺🇸</option>
                        <option value="ar">العربية 🇪🇬</option>
                        <option value="fr">Français 🇫🇷</option>
                        <option value="es">Español 🇪🇸</option>
                        <option value="de">Deutsch 🇩🇪</option>
                        <option value="it">Italiano 🇮🇹</option>
                        <option value="pt">Português 🇵🇹</option>
                        <option value="ru">Русский 🇷🇺</option>
                        <option value="ja">日本語 🇯🇵</option>
                        <option value="ko">한국어 🇰🇷</option>
                        <option value="zh">中文 🇨🇳</option>
                        <option value="hi">हिन्दी 🇮🇳</option>
                        <option value="tr">Türkçe 🇹🇷</option>
                        <option value="nl">Nederlands 🇳🇱</option>
                    </select>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- رسائل الدردشة ستظهر هنا -->
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="اكتب رسالتك هنا..." dir="rtl">
                <button class="voice-btn" id="voiceBtn" title="تسجيل صوتي">
                    🎤
                </button>
                <button class="send-btn" id="sendBtn" title="إرسال">
                    ➤
                </button>
            </div>
        </div>
        
        <!-- واجهة وضع وجهاً لوجه -->
        <div class="panes" id="conversationPanes">
            <!-- لوحة المتحدث الأول -->
            <div class="pane a" id="paneA">
                <div class="pane-header">
                    <h3 class="pane-title">👤 المتحدث الأول</h3>
                    <select class="lang-select" id="langA">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Português</option>
                        <option value="ru">Русский</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                        <option value="zh">中文</option>
                        <option value="hi">हिन्दी</option>
                        <option value="tr">Türkçe</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                    </select>
                </div>
                
                <div class="scroll" id="scrollA">
                    <div class="empty-state">
                        <div class="empty-icon">💬</div>
                        <div class="empty-text">ابدأ المحادثة بالضغط على الميكروفون</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="mic-btn" id="micA" data-speaker="a" title="اضغط للتحدث">
                        <span class="mic-icon">🎤</span>
                        <span class="mic-text">اضغط للتحدث</span>
                    </button>
                    <button class="play-btn" id="playA" title="تشغيل الترجمة الصوتية" style="display: none;">
                        <span class="play-icon">🔊</span>
                    </button>
                </div>
            </div>
            
            <!-- لوحة المتحدث الثاني -->
            <div class="pane b" id="paneB">
                <div class="pane-header">
                    <h3 class="pane-title">👤 المتحدث الثاني</h3>
                    <select class="lang-select" id="langB">
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Português</option>
                        <option value="ru">Русский</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                        <option value="zh">中文</option>
                        <option value="hi">हिन्दी</option>
                        <option value="tr">Türkçe</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                    </select>
                </div>
                
                <div class="scroll" id="scrollB">
                    <div class="empty-state">
                        <div class="empty-icon">💬</div>
                        <div class="empty-text">Click microphone to start speaking</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="mic-btn" id="micB" data-speaker="b" title="Click to speak">
                        <span class="mic-icon">🎤</span>
                        <span class="mic-text">Click to speak</span>
                    </button>
                    <button class="play-btn" id="playB" title="Play audio translation" style="display: none;">
                        <span class="play-icon">🔊</span>
                    </button>
                </div>
            </div>
        </div>

        
        <!-- التذييل -->
        <div class="footer">

            <div style="font-size: 0.8rem; color: var(--brand-muted);" id="stats">
                الرسائل: 0 | الترجمات: 0
            </div>
        </div>
    </div>
    

    
    <script>
        // متغيرات عامة
        let recognition;
        let isListening = false;
        let currentSpeaker = null;
        let conversationData = [];
        let messageCount = 0;
        let translationCount = 0;
        let lastProcessedText = '';
        let processingTimeout = null;
        

        
        // إعدادات مدة التسجيل
        let recordingTimeout = null;
        let maxRecordingTime = 300000; // 300 ثانية (5 دقائق)
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
            setupEventListeners();
            updateStats();
        });
        
        // تهيئة التعرف على الكلام
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false; // تغيير إلى false لمنع التكرار
                recognition.interimResults = false; // تغيير إلى false للحصول على نتائج نهائية فقط
                recognition.maxAlternatives = 1; // الحصول على بديل واحد فقط
                
                recognition.onstart = function() {
                    isListening = true;
                    updateMicState(currentSpeaker, 'listening');
                };
                
                recognition.onresult = function(event) {
                    // الحصول على النتيجة النهائية فقط
                    const result = event.results[event.results.length - 1];
                    if (result.isFinal) {
                        const transcript = result[0].transcript;
                        // إعادة تعيين محاولات الشبكة عند نجاح العملية
                        networkRetryAttempts = 0;
                        console.log('Speech recognition successful, network retry attempts reset');
                        processTranscript(transcript, currentSpeaker);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('خطأ في التعرف على الكلام:', event.error);
                    
                    // تسجيل تفصيلي للخطأ
                    console.warn('Speech Recognition Error Details:', {
                        error: event.error,
                        speaker: currentSpeaker,
                        timestamp: new Date().toISOString(),
                        isListening: isListening,
                        networkRetryAttempts: networkRetryAttempts
                    });
                    
                    // معالجة أنواع مختلفة من الأخطاء
                    let errorMessage = '';
                    let showRetryOption = false;
                    
                    switch(event.error) {
                        case 'network':
                            console.log('Network error detected, handling with improved retry mechanism');
                            handleNetworkError(currentSpeaker);
                            return;
                        case 'not-allowed':
                            errorMessage = 'يرجى السماح بالوصول إلى الميكروفون من إعدادات المتصفح. انقر على أيقونة القفل في شريط العنوان.';
                            // إعادة تعيين محاولات الشبكة عند مشاكل الصلاحيات
                            networkRetryAttempts = 0;
                            break;
                        case 'no-speech':
                            errorMessage = 'لم يتم اكتشاف أي كلام. تأكد من أن الميكروفون يعمل وتحدث بوضوح.';
                            showRetryOption = true;
                            break;
                        case 'audio-capture':
                            errorMessage = 'خطأ في التقاط الصوت. تحقق من توصيل الميكروفون وإعداداته.';
                            showRetryOption = true;
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'خدمة التعرف على الصوت غير متاحة. تحقق من اتصال الإنترنت.';
                            showRetryOption = true;
                            break;
                        case 'bad-grammar':
                            errorMessage = 'خطأ في إعدادات التعرف على الصوت. جاري إعادة المحاولة...';
                            showRetryOption = true;
                            break;
                        case 'language-not-supported':
                            errorMessage = 'اللغة المحددة غير مدعومة. سيتم استخدام اللغة الافتراضية.';
                            showRetryOption = true;
                            break;
                        case 'aborted':
                            // لا نعرض رسالة للإلغاء المقصود
                            stopListening();
                            return;
                        default:
                            errorMessage = `خطأ في التعرف على الصوت: ${event.error}. جاري إعادة المحاولة...`;
                            showRetryOption = true;
                            break;
                    }
                    
                    // عرض رسالة الخطأ للمستخدم مع خيار إعادة المحاولة إذا كان مناسباً
                    if (showRetryOption) {
                        showErrorMessageWithRetry(errorMessage, currentSpeaker);
                    } else {
                        showErrorMessage(errorMessage);
                    }
                    
                    stopListening();
                };
                
                recognition.onend = function() {
                    stopListening();
                };
            } else {
                alert('متصفحك لا يدعم التعرف على الكلام');
            }
        }
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {

            document.getElementById('darkMode').addEventListener('click', toggleDarkMode);
            document.getElementById('saveChat').addEventListener('click', saveConversation);
            document.getElementById('clearChat').addEventListener('click', clearConversation);
            document.getElementById('homeBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

        }
        

        
        // تبديل حالة الاستماع
        function toggleListening(speaker) {
            if (isListening && currentSpeaker === speaker) {
                stopListening();
            } else {
                startListening(speaker);
            }
        }
        
        // بدء الاستماع
        function startListening(speaker) {
            if (isListening) {
                stopListening();
            }
            
            currentSpeaker = speaker;
            const lang = document.getElementById(`lang${speaker}`).value;
            recognition.lang = lang;
            recognition.start();
            
            showVoiceWave(speaker);
            
            // تحديث وقت آخر كلام للوضع التلقائي
            lastSpeechTime = Date.now();
            
            // إعداد timeout للتسجيل (3 دقائق كحد أقصى)
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            recordingTimeout = setTimeout(() => {
                if (isListening) {
                    showErrorMessage('انتهت مدة التسجيل المسموحة (3 دقائق). يرجى المحاولة مرة أخرى.');
                    stopListening();
                }
            }, maxRecordingTime);
            
            // بدء كشف الصمت في الوضع التلقائي
            if (isHandsfreeMode) {
                detectSilenceInHandsfree();
            }
        }
        
        // إيقاف الاستماع
        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            
            // تنظيف timeout التسجيل
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            isListening = false;
            updateMicState(currentSpeaker, 'idle');
            hideVoiceWave(currentSpeaker);
            currentSpeaker = null;
        }
        
        // تحديث حالة المايكروفون
        function updateMicState(speaker, state) {
            if (!speaker) return;
            
            const mic = document.getElementById(`mic${speaker}`);
            const micText = mic.querySelector('.mic-text');
            
            mic.setAttribute('data-state', state);
            
            if (state === 'listening') {
                micText.textContent = speaker === 'A' ? 'جاري الاستماع...' : 'Listening...';
            } else {
                micText.textContent = speaker === 'A' ? 'اضغط للتحدث' : 'Click to speak';
            }
        }
        
        // إظهار موجات الصوت
        function showVoiceWave(speaker) {
            const wave = document.getElementById(`wave${speaker}`);
            wave.classList.add('active');
        }
        
        // إخفاء موجات الصوت
        function hideVoiceWave(speaker) {
            if (!speaker) return;
            const wave = document.getElementById(`wave${speaker}`);
            wave.classList.remove('active');
        }
        
        // معالجة النص المنطوق
        async function processTranscript(text, speaker) {
            // تنظيف النص وإزالة المسافات الزائدة
            const cleanText = text.trim();
            
            // تجنب معالجة النصوص الفارغة أو القصيرة جداً
            if (!cleanText || cleanText.length < 2) {
                return;
            }
            
            // منع معالجة نفس النص مرتين متتاليتين
            if (cleanText === lastProcessedText) {
                return;
            }
            
            // إلغاء أي معالجة سابقة معلقة
            if (processingTimeout) {
                clearTimeout(processingTimeout);
            }
            
            // تأخير قصير للتأكد من اكتمال النص
            processingTimeout = setTimeout(async () => {
                lastProcessedText = cleanText;
                
                // تحديث وقت آخر كلام للوضع التلقائي
                lastSpeechTime = Date.now();
                
                const sourceLang = document.getElementById(`lang${speaker}`).value;
                const targetLang = document.getElementById(`lang${speaker === 'A' ? 'B' : 'A'}`).value;
                
                // إضافة الرسالة الأصلية
                addMessage(cleanText, speaker, 'original');
                
                // ترجمة النص
                try {
                    const translation = await translateText(cleanText, sourceLang, targetLang);
                    addMessage(translation, speaker === 'A' ? 'B' : 'A', 'translation');
                    
                    // تشغيل الترجمة صوتياً
                    speakText(translation, targetLang);
                    
                    translationCount++;
                    updateStats();
                    

                } catch (error) {
                    console.error('خطأ في الترجمة:', error);
                }
                
                messageCount++;
                updateStats();
                
                // إيقاف الاستماع
                stopListening();
                
                // مسح النص المعالج بعد فترة
                setTimeout(() => {
                    lastProcessedText = '';
                }, 3000);
            }, 500); // تأخير نصف ثانية للتأكد من اكتمال النص
        }
        
        // إضافة رسالة للمحادثة
        function addMessage(text, targetSpeaker, type) {
            const chatArea = document.getElementById(`scroll${targetSpeaker}`);
            
            // إزالة رسالة "ابدأ المحادثة" إذا كانت موجودة
            const placeholder = chatArea.querySelector('[style*="text-align: center"]');
            if (placeholder) {
                placeholder.remove();
            }
            
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${type === 'original' ? 'me' : 'them'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `bubble ${type}`;
            bubble.textContent = text;
            
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            if (type === 'translation') {
                const playBtn = document.createElement('button');
                playBtn.className = 'action-btn';
                playBtn.textContent = '🔊';
                playBtn.title = 'تشغيل';
                playBtn.onclick = () => {
                    const lang = document.getElementById(`lang${targetSpeaker}`).value;
                    speakText(text, lang);
                };
                actions.appendChild(playBtn);
            }
            
            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn';
            editBtn.textContent = '✏️';
            editBtn.title = 'تعديل';
            editBtn.onclick = () => editMessage(bubble);
            actions.appendChild(editBtn);
            
            messageGroup.appendChild(bubble);
            messageGroup.appendChild(actions);
            chatArea.appendChild(messageGroup);
            
            // التمرير للأسفل
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // حفظ في بيانات المحادثة
            conversationData.push({
                text: text,
                speaker: targetSpeaker,
                type: type,
                timestamp: new Date().toISOString()
            });
        }
        
        // تعديل رسالة
        function editMessage(bubble) {
            const currentText = bubble.textContent;
            const newText = prompt('تعديل الرسالة:', currentText);
            if (newText && newText !== currentText) {
                bubble.textContent = newText;
            }
        }
        
        // تخزين مؤقت للترجمات
        const translationCache = new Map();
        
        // ترجمة النص المحسنة
        async function translateText(text, sourceLang, targetLang) {
            if (sourceLang === targetLang) {
                return text;
            }
            
            // التحقق من التخزين المؤقت
            const cacheKey = `${text}_${sourceLang}_${targetLang}`;
            if (translationCache.has(cacheKey)) {
                return translationCache.get(cacheKey);
            }
            
            try {
                // محاولة الترجمة مع timeout محسن
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 ثوانٍ timeout
                
                const response = await fetch(
                    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`,
                    { 
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                    const translation = data.responseData.translatedText;
                    
                    // حفظ في التخزين المؤقت
                    translationCache.set(cacheKey, translation);
                    
                    // تنظيف التخزين المؤقت إذا أصبح كبيراً
                    if (translationCache.size > 100) {
                        const firstKey = translationCache.keys().next().value;
                        translationCache.delete(firstKey);
                    }
                    
                    return translation;
                } else {
                    throw new Error('Invalid response from translation service');
                }
                
            } catch (error) {
                console.error('خطأ في الترجمة:', error);
                
                // محاولة خدمة ترجمة احتياطية
                try {
                    return await fallbackTranslation(text, sourceLang, targetLang);
                } catch (fallbackError) {
                    console.error('خطأ في الترجمة الاحتياطية:', fallbackError);
                    showErrorMessage('فشل في الترجمة. يرجى التحقق من الاتصال بالإنترنت والمحاولة مرة أخرى.');
                    return text;
                }
            }
        }
        
        // خدمة ترجمة احتياطية
        async function fallbackTranslation(text, sourceLang, targetLang) {
            // استخدام Google Translate كخدمة احتياطية
            const response = await fetch(
                `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`,
                {
                    headers: {
                        'Accept': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error('Fallback translation failed');
            }
            
            const data = await response.json();
            
            if (data && data[0] && data[0][0] && data[0][0][0]) {
                return data[0][0][0];
            } else {
                throw new Error('Invalid fallback response');
            }
        }
        
        // تشغيل النص صوتياً المحسن
        function speakText(text, lang) {
            if ('speechSynthesis' in window) {
                // إيقاف أي تشغيل صوتي سابق
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 1.0; // سرعة محسنة
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                // معالجة الأخطاء
                utterance.onerror = function(event) {
                    console.error('خطأ في التشغيل الصوتي:', event.error);
                };
                
                // تحسين التشغيل للنصوص الطويلة
                if (text.length > 200) {
                    // تقسيم النص الطويل إلى أجزاء أصغر
                    const chunks = text.match(/.{1,200}(\s|$)/g) || [text];
                    let currentChunk = 0;
                    
                    function speakNextChunk() {
                        if (currentChunk < chunks.length) {
                            const chunkUtterance = new SpeechSynthesisUtterance(chunks[currentChunk]);
                            chunkUtterance.lang = lang;
                            chunkUtterance.rate = 1.0;
                            chunkUtterance.pitch = 1.0;
                            chunkUtterance.volume = 0.8;
                            
                            chunkUtterance.onend = function() {
                                currentChunk++;
                                setTimeout(speakNextChunk, 100); // توقف قصير بين الأجزاء
                            };
                            
                            speechSynthesis.speak(chunkUtterance);
                        }
                    }
                    
                    speakNextChunk();
                } else {
                    speechSynthesis.speak(utterance);
                }
            }
        }
        
        // تبديل اللغات
        function swapLanguages() {
            const langA = document.getElementById('langA');
            const langB = document.getElementById('langB');
            const tempValue = langA.value;
            langA.value = langB.value;
            langB.value = tempValue;
            
            // تحديث شريط اللغات العلوي
            updateLanguageBar();
        }
        
        // تحديث شريط اللغات
        function updateLanguageBar() {
            // يمكن إضافة منطق لتحديث الأعلام والأسماء
        }
        
        // تبديل الوضع الليلي
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }
        
        // عرض رسالة خطأ للمستخدم
        function showErrorMessage(message) {
            createErrorMessage(message, false, null);
        }
        
        // عرض رسالة خطأ مع خيار إعادة المحاولة
        function showErrorMessageWithRetry(message, speaker) {
            createErrorMessage(message, true, speaker);
        }
        
        // إنشاء رسالة خطأ محسنة
        function createErrorMessage(message, showRetry, speaker, errorType = 'default') {
            // إزالة أي رسالة خطأ سابقة
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // إنشاء عنصر رسالة الخطأ
            const errorDiv = document.createElement('div');
            let className = 'error-message';
            
            // إضافة أنماط حسب نوع الخطأ
            if (errorType === 'network') {
                className += ' network-error';
            } else if (errorType === 'auto-retry') {
                className += ' auto-retry';
            }
            
            errorDiv.className = className;
            
            let retryButton = '';
            if (showRetry && speaker) {
                retryButton = `<button class="error-retry" onclick="retryListening('${speaker}'); this.parentElement.parentElement.remove();">إعادة المحاولة</button>`;
            }
            
            // أيقونة مختلفة حسب نوع الخطأ
            let icon = '⚠️';
            if (errorType === 'network') {
                icon = '🌐';
            } else if (errorType === 'auto-retry') {
                icon = '🔄';
            }
            
            errorDiv.innerHTML = `
                <div class="error-content">
                    <span class="error-icon">${icon}</span>
                    <span class="error-text">${message}</span>
                    <div class="error-actions">
                        ${retryButton}
                        <button class="error-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                </div>
            `;
            
            // إضافة الأنماط إذا لم تكن موجودة
            if (!document.querySelector('#error-styles')) {
                const style = document.createElement('style');
                style.id = 'error-styles';
                style.textContent = `
                    .error-message {
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 1000;
                        background: #ff4757;
                        color: white;
                        padding: 0;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
                        animation: slideDown 0.3s ease-out;
                        max-width: 90%;
                        min-width: 300px;
                    }
                    
                    .error-content {
                        display: flex;
                        align-items: center;
                        padding: 12px 16px;
                        gap: 10px;
                    }
                    
                    .error-icon {
                        font-size: 18px;
                        flex-shrink: 0;
                    }
                    
                    .error-text {
                        flex: 1;
                        font-size: 14px;
                        line-height: 1.4;
                    }
                    
                    .error-actions {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .error-retry {
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 4px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .error-retry:hover {
                        background: rgba(255, 255, 255, 0.3);
                        border-color: rgba(255, 255, 255, 0.5);
                    }
                    
                    /* مؤشر إعادة المحاولة التلقائية */
                    .error-message.auto-retry {
                        background: #ff9500;
                        animation: slideDown 0.3s ease-out, autoRetryPulse 2s infinite;
                    }
                    
                    .error-message.network-error {
                        background: #ff6b6b;
                    }
                    
                    .retry-countdown {
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        font-weight: bold;
                        animation: countdown 1s infinite;
                    }
                    
                    @keyframes autoRetryPulse {
                        0%, 100% { box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3); }
                        50% { box-shadow: 0 4px 20px rgba(255, 149, 0, 0.5); }
                    }
                    
                    @keyframes countdown {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    
                    .error-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s;
                    }
                    
                    .error-close:hover {
                        background-color: rgba(255, 255, 255, 0.2);
                    }
                    
                    @keyframes slideDown {
                        from {
                            transform: translateX(-50%) translateY(-100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(-50%) translateY(0);
                            opacity: 1;
                        }
                    }
                    
                    .dark-mode .error-message {
                        background: #ff3742;
                        box-shadow: 0 4px 12px rgba(255, 55, 66, 0.4);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // إضافة الرسالة إلى الصفحة
            document.body.appendChild(errorDiv);
            
            // إزالة الرسالة تلقائياً بعد 8 ثوانٍ (وقت أطول للرسائل مع إعادة المحاولة)
            const autoRemoveTime = showRetry ? 8000 : 5000;
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, autoRemoveTime);
        }
        
        // إعادة المحاولة للاستماع
        function retryListening(speaker) {
            // إزالة رسائل الخطأ السابقة
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // تأخير قصير قبل إعادة المحاولة لضمان استقرار الاتصال
            setTimeout(() => {
                console.log(`Retrying speech recognition for ${speaker}`);
                startListening(speaker);
            }, 500);
        }
        
        // حفظ المحادثة
        function saveConversation() {
            if (conversationData.length === 0) {
                showErrorMessage('لا توجد محادثة لحفظها');
                return;
            }
            
            const dataStr = JSON.stringify(conversationData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `conversation_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // مسح المحادثة
        function clearConversation() {
            if (confirm('هل أنت متأكد من مسح المحادثة؟')) {
                document.getElementById('scrollA').innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">💬</div><div>ابدأ المحادثة...</div></div>';
                document.getElementById('scrollB').innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">💬</div><div>Start conversation...</div></div>';
                conversationData = [];
                messageCount = 0;
                translationCount = 0;
                updateStats();
            }
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `الرسائل: ${messageCount} | الترجمات: ${translationCount}`;
        }
        
        // تحميل الإعدادات المحفوظة
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // مراقبة حالة الاتصال بالإنترنت
        let isOnline = navigator.onLine;
        let lastNetworkError = null;
        let networkRetryAttempts = 0;
        const maxRetryAttempts = 3;
        
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                status.textContent = '🟢';
                text.textContent = 'متصل';
                networkRetryAttempts = 0;
            } else {
                indicator.className = 'connection-indicator offline';
                status.textContent = '🔴';
                text.textContent = 'غير متصل';
            }
        }
        
        // مراقبة تغيير حالة الاتصال
        window.addEventListener('online', function() {
            isOnline = true;
            updateConnectionStatus();
            
            // إعادة المحاولة التلقائية إذا كان هناك خطأ شبكة سابق
            if (lastNetworkError && lastNetworkError.speaker) {
                setTimeout(() => {
                    showErrorMessageWithRetry('تم استعادة الاتصال. هل تريد إعادة المحاولة؟', lastNetworkError.speaker);
                    lastNetworkError = null;
                }, 1000);
            }
        });
        
        window.addEventListener('offline', function() {
            isOnline = false;
            updateConnectionStatus();
            showErrorMessage('انقطع الاتصال بالإنترنت. سيتم إعادة المحاولة عند استعادة الاتصال.');
        });
        
        // تحسين معالجة أخطاء الشبكة
        function handleNetworkError(speaker) {
            const timestamp = Date.now();
            lastNetworkError = { speaker, timestamp };
            
            // تسجيل مفصل للخطأ
            console.warn('Speech Recognition Network Error:', {
                speaker: speaker,
                timestamp: new Date(timestamp).toISOString(),
                isOnline: isOnline,
                retryAttempts: networkRetryAttempts,
                userAgent: navigator.userAgent,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'unknown'
            });
            
            // التحقق من حالة الاتصال
            if (!isOnline) {
                createErrorMessage('لا يوجد اتصال بالإنترنت. سيتم إعادة المحاولة تلقائياً عند استعادة الاتصال.', false, null, 'network');
                return;
            }
            
            // التحقق من صحة المتصفح لخدمة التعرف على الكلام
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showErrorMessage('متصفحك لا يدعم خدمة التعرف على الكلام عبر الإنترنت.');
                return;
            }
            
            networkRetryAttempts++;
            
            if (networkRetryAttempts <= maxRetryAttempts) {
                // إعادة محاولة تلقائية مع تأخير متدرج
                const retryDelay = Math.min(1000 * Math.pow(2, networkRetryAttempts - 1), 8000); // تأخير متدرج: 1s, 2s, 4s, 8s
                const retryMessage = `خطأ في الشبكة (المحاولة ${networkRetryAttempts}/${maxRetryAttempts}). <span class="retry-countdown">إعادة المحاولة خلال ${Math.ceil(retryDelay/1000)} ثانية... ⏱️</span>`;
                
                createErrorMessage(retryMessage, false, null, 'auto-retry');
                
                // إعادة محاولة تلقائية
                setTimeout(() => {
                    console.log(`Auto-retrying speech recognition for ${speaker} (attempt ${networkRetryAttempts})`);
                    retryListening(speaker);
                }, retryDelay);
            } else {
                const finalMessage = `فشل في الاتصال بخدمة التعرف على الصوت بعد ${maxRetryAttempts} محاولات. يرجى التحقق من اتصال الإنترنت.`;
                createErrorMessage(finalMessage, true, speaker, 'network');
                networkRetryAttempts = 0; // إعادة تعيين العداد
            }
        }
        
        // تحديث حالة الاتصال عند التحميل
        updateConnectionStatus();

        // إدارة أوضاع المحادثة
        class ConversationModeManager {
            constructor() {
                this.currentMode = 'face-to-face';
                this.isRecording = false;
                this.chatMessages = [];
                this.currentUser = null;
                this.connectedUsers = new Map();
                this.init();
            }

            init() {
                this.checkUserAuthentication();
                this.setupModeButtons();
                this.setupRemoteChat();
                this.updateUI();
                this.updateLanguageSettings();
                this.updateModeButtons();
            }

            setupModeButtons() {
                const faceToFaceBtn = document.getElementById('faceToFaceMode');
                const remoteBtn = document.getElementById('remoteMode');

                faceToFaceBtn?.addEventListener('click', () => this.switchMode('face-to-face'));
                remoteBtn?.addEventListener('click', () => this.switchMode('remote'));
            }

            setupRemoteChat() {
                const sendBtn = document.getElementById('sendBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                const chatInput = document.getElementById('chatInput');
                const myLanguageSelect = document.getElementById('myLanguageRemote');
                const targetLanguageSelect = document.getElementById('targetLanguageRemote');
                const langSwapBtn = document.getElementById('langSwapRemote');

                sendBtn?.addEventListener('click', () => this.sendMessage());
                voiceBtn?.addEventListener('click', () => this.toggleVoiceRecording());
                chatInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
                
                // إضافة مستمعين لتغيير اللغة
                myLanguageSelect?.addEventListener('change', () => this.updateLanguageSettings());
                targetLanguageSelect?.addEventListener('change', () => this.updateLanguageSettings());
                
                // إضافة مستمع لزر التبديل
                langSwapBtn?.addEventListener('click', () => this.swapLanguages());
            }
            
            updateLanguageSettings() {
                const myLang = document.getElementById('myLanguageRemote')?.value;
                const targetLang = document.getElementById('targetLanguageRemote')?.value;
                
                // تحديث placeholder حسب اللغة المختارة
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    const placeholders = {
                        'ar': 'اكتب رسالتك هنا...',
                        'en': 'Type your message here...',
                        'fr': 'Tapez votre message ici...',
                        'es': 'Escribe tu mensaje aquí...',
                        'de': 'Geben Sie Ihre Nachricht hier ein...',
                        'it': 'Digita il tuo messaggio qui...',
                        'pt': 'Digite sua mensagem aqui...',
                        'ru': 'Введите ваше сообщение здесь...',
                        'ja': 'ここにメッセージを入力してください...',
                        'ko': '여기에 메시지를 입력하세요...',
                        'zh': '在此输入您的消息...'
                    };
                    chatInput.placeholder = placeholders[myLang] || placeholders['ar'];
                    chatInput.dir = ['ar'].includes(myLang) ? 'rtl' : 'ltr';
                }
                
                console.log(`تم تحديث اللغات: لغتي ${myLang} -> لغة الطرف الآخر ${targetLang}`);
            }
            
            swapLanguages() {
                const myLanguageSelect = document.getElementById('myLanguageRemote');
                const targetLanguageSelect = document.getElementById('targetLanguageRemote');
                
                if (myLanguageSelect && targetLanguageSelect) {
                    // حفظ القيم الحالية
                    const myLang = myLanguageSelect.value;
                    const targetLang = targetLanguageSelect.value;
                    
                    // تبديل القيم
                    myLanguageSelect.value = targetLang;
                    targetLanguageSelect.value = myLang;
                    
                    // تحديث الإعدادات
                    this.updateLanguageSettings();
                    
                    console.log(`تم تبديل اللغات: ${myLang} ↔ ${targetLang}`);
                }
            }

            checkUserAuthentication() {
                // التحقق من جلسة المستخدم الحالية
                const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
                const guestSession = localStorage.getItem('guest_session');
                
                if (userSession) {
                    try {
                        const userData = JSON.parse(userSession);
                        if (userData.isLoggedIn) {
                            this.currentUser = userData;
                            console.log('مستخدم مسجل:', userData.email);
                            return;
                        }
                    } catch (error) {
                        console.error('خطأ في قراءة بيانات المستخدم:', error);
                    }
                }
                
                if (guestSession) {
                    try {
                        const guestData = JSON.parse(guestSession);
                        this.currentUser = { ...guestData, isGuest: true };
                        console.log('جلسة ضيف نشطة:', guestData.sessionId);
                        return;
                    } catch (error) {
                        console.error('خطأ في قراءة جلسة الضيف:', error);
                    }
                }
                
                console.log('لا توجد جلسة نشطة');
            }

            switchMode(mode) {
                // التحقق من المصادقة للوضع Remote
                if (mode === 'remote' && !this.currentUser) {
                    this.showAuthenticationRequired();
                    return;
                }
                
                this.currentMode = mode;
                this.updateUI();
                this.updateModeButtons();
                
                // إذا كان الوضع remote وهناك مستخدم مسجل، تحديث واجهة المستخدم
                if (mode === 'remote' && this.currentUser) {
                    this.updateRemoteChatForAuthenticatedUser();
                }
            }

            updateModeButtons() {
                const faceToFaceBtn = document.getElementById('faceToFaceMode');
                const remoteBtn = document.getElementById('remoteMode');

                faceToFaceBtn?.classList.toggle('active', this.currentMode === 'face-to-face');
                remoteBtn?.classList.toggle('active', this.currentMode === 'remote');
            }

            updateUI() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                const conversationPanes = document.getElementById('conversationPanes');

                if (this.currentMode === 'remote') {
                    remoteChatContainer?.classList.add('active');
                    conversationPanes?.style.setProperty('display', 'none');
                    conversationPanes?.classList.remove('face-to-face');
                } else {
                    remoteChatContainer?.classList.remove('active');
                    conversationPanes?.style.setProperty('display', 'grid');
                    conversationPanes?.classList.remove('remote');
                    conversationPanes?.classList.add('face-to-face');
                }
            }

            showAuthenticationRequired() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (remoteChatContainer) {
                    // إظهار رسالة تطلب تسجيل الدخول
                    const authMessage = document.createElement('div');
                    authMessage.className = 'auth-required-message';
                    authMessage.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; margin: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">🔐</div>
                            <h3 style="color: var(--brand-primary); margin-bottom: 12px;">تسجيل الدخول مطلوب</h3>
                            <p style="color: #64748b; margin-bottom: 20px;">للتحدث عن بُعد، يجب تسجيل الدخول أولاً</p>
                            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="window.location.href='login.html'" style="background: var(--brand-primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">تسجيل الدخول</button>
                                <button onclick="conversationModeManager.switchMode('face-to-face')" style="background: #e2e8f0; color: #475569; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">العودة للوضع المحلي</button>
                            </div>
                        </div>
                    `;
                    
                    // إزالة أي رسالة سابقة
                    const existingMessage = remoteChatContainer.querySelector('.auth-required-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    
                    remoteChatContainer.appendChild(authMessage);
                    remoteChatContainer.classList.add('active');
                }
            }

            updateRemoteChatForAuthenticatedUser() {
                const remoteConnectionStatus = document.getElementById('remoteConnectionStatus');
                const remoteChatTitle = document.querySelector('.remote-chat-title');
                
                if (remoteConnectionStatus && this.currentUser) {
                    if (this.currentUser.isGuest) {
                        remoteConnectionStatus.innerHTML = `
                            <span>👤</span>
                            <span>ضيف - ${this.currentUser.sessionId?.substring(0, 8) || 'غير معروف'}</span>
                        `;
                    } else {
                        remoteConnectionStatus.innerHTML = `
                            <span>✅</span>
                            <span>مسجل - ${this.currentUser.email || 'مستخدم'}</span>
                        `;
                    }
                }
                
                if (remoteChatTitle) {
                    remoteChatTitle.textContent = this.currentUser.isGuest ? 
                        '💬 محادثة عن بُعد (ضيف)' : 
                        '💬 محادثة عن بُعد (مسجل)';
                }
                
                // إزالة أي رسالة مصادقة موجودة
                const authMessage = document.querySelector('.auth-required-message');
                if (authMessage) {
                    authMessage.remove();
                }
                
                // عرض واجهة ربط المستخدمين
                this.showUserMatchingInterface();
            }

            async sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput?.value.trim();

                if (!message) return;

                // إضافة الرسالة المرسلة
                this.addChatBubble(message, 'sent');
                chatInput.value = '';

                // محاكاة الترجمة والرد
                try {
                    const translatedMessage = await this.translateMessage(message);
                    
                    // محاكاة تأخير الشبكة
                    setTimeout(() => {
                        this.addChatBubble(translatedMessage, 'received', message);
                    }, 1000 + Math.random() * 2000);
                } catch (error) {
                    console.error('خطأ في الترجمة:', error);
                }
            }

            async translateMessage(text) {
                // استخدام خيارات اللغة من Remote mode
                const fromLang = document.getElementById('myLanguageRemote')?.value || 'ar';
                const toLang = document.getElementById('targetLanguageRemote')?.value || 'en';
                
                try {
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`);
                    const data = await response.json();
                    return data.responseData?.translatedText || text;
                } catch (error) {
                    console.error('خطأ في الترجمة:', error);
                    return `[ترجمة] ${text}`;
                }
            }

            addChatBubble(message, type, originalText = null) {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;

                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${type}`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let content = `<div class="bubble-content">`;
                
                if (type === 'received' && originalText) {
                    content += `<div class="bubble-original">${originalText}</div>`;
                    content += `<div class="bubble-translation">${message}</div>`;
                } else {
                    content += `<div class="bubble-original">${message}</div>`;
                }
                
                content += `</div><div class="bubble-time">${timeStr}</div>`;
                bubble.innerHTML = content;

                chatMessages.appendChild(bubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // حفظ الرسالة
                this.chatMessages.push({
                    message,
                    type,
                    originalText,
                    timestamp: now.toISOString()
                });
            }

            // نظام ربط المستخدمين
            async findAvailableUsers() {
                // محاكاة البحث عن المستخدمين المتاحين
                const availableUsers = [
                    { id: 'user1', name: 'أحمد محمد', status: 'online', language: 'ar' },
                    { id: 'user2', name: 'Sarah Johnson', status: 'online', language: 'en' },
                    { id: 'user3', name: 'Marie Dubois', status: 'online', language: 'fr' },
                    { id: 'user4', name: 'محمد علي', status: 'online', language: 'ar' }
                ];
                
                // تصفية المستخدمين (استبعاد المستخدم الحالي)
                return availableUsers.filter(user => 
                    user.id !== this.currentUser?.id && 
                    user.status === 'online'
                );
            }

            showUserMatchingInterface() {
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (!remoteChatContainer) return;
                
                const matchingInterface = document.createElement('div');
                matchingInterface.className = 'user-matching-interface';
                matchingInterface.innerHTML = `
                    <div style="padding: 20px; background: white; border-radius: 12px; margin: 20px;">
                        <h3 style="color: var(--brand-primary); margin-bottom: 16px; text-align: center;">🌐 البحث عن محادثة</h3>
                        

                        
                        <div id="usersList" style="display: none;"></div>
                        <div id="searchingIndicator" style="display: none; text-align: center; padding: 20px;">
                            <div style="font-size: 2rem; margin-bottom: 12px;">🔍</div>
                            <p style="color: #64748b;">جاري البحث عن مستخدمين متاحين...</p>
                        </div>
                    </div>
                `;
                
                // إزالة أي واجهة سابقة
                const existingInterface = remoteChatContainer.querySelector('.user-matching-interface');
                if (existingInterface) {
                    existingInterface.remove();
                }
                
                remoteChatContainer.appendChild(matchingInterface);
            }

            async showAvailableUsers() {
                const usersList = document.getElementById('usersList');
                const searchingIndicator = document.getElementById('searchingIndicator');
                
                if (!usersList || !searchingIndicator) return;
                
                searchingIndicator.style.display = 'block';
                usersList.style.display = 'none';
                
                try {
                    const users = await this.findAvailableUsers();
                    
                    setTimeout(() => {
                        searchingIndicator.style.display = 'none';
                        
                        if (users.length === 0) {
                            usersList.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: #64748b;">
                                    <div style="font-size: 2rem; margin-bottom: 12px;">😔</div>
                                    <p>لا يوجد مستخدمين متاحين حالياً</p>
                                </div>
                            `;
                        } else {
                            usersList.innerHTML = `
                                <h4 style="margin-bottom: 12px; color: var(--brand-text);">المستخدمين المتاحين:</h4>
                                ${users.map(user => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--brand-text);">${user.name}</div>
                                            <div style="font-size: 0.85rem; color: #64748b;">🌐 ${this.getLanguageName(user.language)}</div>
                                        </div>
                                        <button onclick="conversationModeManager.connectToUser('${user.id}', '${user.name}')" style="background: var(--brand-primary); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">اتصال</button>
                                    </div>
                                `).join('')}
                            `;
                        }
                        
                        usersList.style.display = 'block';
                    }, 1500);
                } catch (error) {
                    console.error('خطأ في جلب المستخدمين:', error);
                    searchingIndicator.style.display = 'none';
                    usersList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ef4444;">
                            <p>حدث خطأ في البحث عن المستخدمين</p>
                        </div>
                    `;
                    usersList.style.display = 'block';
                }
            }

            async findRandomUser() {
                const searchingIndicator = document.getElementById('searchingIndicator');
                if (searchingIndicator) {
                    searchingIndicator.style.display = 'block';
                    searchingIndicator.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 12px;">🎲</div>
                        <p style="color: #64748b;">جاري البحث عن محادثة عشوائية...</p>
                    `;
                }
                
                try {
                    const users = await this.findAvailableUsers();
                    
                    setTimeout(() => {
                        if (users.length > 0) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            this.connectToUser(randomUser.id, randomUser.name);
                        } else {
                            if (searchingIndicator) {
                                searchingIndicator.innerHTML = `
                                    <div style="font-size: 2rem; margin-bottom: 12px;">😔</div>
                                    <p style="color: #64748b;">لا يوجد مستخدمين متاحين للمحادثة العشوائية</p>
                                `;
                            }
                        }
                    }, 2000);
                } catch (error) {
                    console.error('خطأ في البحث العشوائي:', error);
                }
            }

            connectToUser(userId, userName) {
                console.log(`محاولة الاتصال بالمستخدم: ${userName} (${userId})`);
                
                // محاكاة الاتصال
                const remoteChatContainer = document.getElementById('remoteChatContainer');
                if (remoteChatContainer) {
                    const connectionInterface = document.createElement('div');
                    connectionInterface.className = 'connection-interface';
                    connectionInterface.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: #f0f9ff; border-radius: 12px; margin: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">📞</div>
                            <h3 style="color: var(--brand-primary); margin-bottom: 12px;">جاري الاتصال...</h3>
                            <p style="color: #64748b; margin-bottom: 20px;">الاتصال بـ ${userName}</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="conversationModeManager.simulateConnection('${userId}', '${userName}')" style="background: var(--brand-secondary); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">محاكاة الاتصال</button>
                            <button onclick="conversationModeManager.cancelConnection()" style="background: #ef4444; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">إلغاء</button>
                            </div>
                        </div>
                    `;
                    
                    // إزالة أي واجهة سابقة
                    const existingInterface = remoteChatContainer.querySelector('.user-matching-interface, .connection-interface');
                    if (existingInterface) {
                        existingInterface.remove();
                    }
                    
                    remoteChatContainer.appendChild(connectionInterface);
                }
            }

            simulateConnection(userId, userName) {
                // محاكاة اتصال ناجح
                this.connectedUsers.set(userId, { name: userName, status: 'connected' });
                
                // إزالة واجهة الاتصال
                const connectionInterface = document.querySelector('.connection-interface');
                if (connectionInterface) {
                    connectionInterface.remove();
                }
                
                // تحديث واجهة المحادثة
                this.updateRemoteChatForConnectedUser(userName);
                
                // إضافة رسالة ترحيب
                setTimeout(() => {
                    this.addChatBubble(`مرحباً! أنا ${userName}`, 'received');
                }, 1000);
            }

            cancelConnection() {
                const connectionInterface = document.querySelector('.connection-interface');
                if (connectionInterface) {
                    connectionInterface.remove();
                }
                this.showUserMatchingInterface();
            }

            updateRemoteChatForConnectedUser(userName) {
                const remoteConnectionStatus = document.getElementById('remoteConnectionStatus');
                const remoteChatTitle = document.querySelector('.remote-chat-title');
                
                if (remoteConnectionStatus) {
                    remoteConnectionStatus.innerHTML = `
                        <span>🟢</span>
                        <span>متصل مع ${userName}</span>
                    `;
                }
                
                if (remoteChatTitle) {
                    remoteChatTitle.textContent = `💬 محادثة مع ${userName}`;
                }
            }

            getLanguageName(langCode) {
                const languages = {
                    'ar': 'العربية',
                    'en': 'English',
                    'fr': 'Français',
                    'es': 'Español',
                    'de': 'Deutsch'
                };
                return languages[langCode] || langCode;
            }

            toggleVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                if (this.isRecording) {
                    this.stopVoiceRecording();
                } else {
                    this.startVoiceRecording();
                }
            }

            startVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                this.isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '⏹️';

                // محاكاة التسجيل الصوتي
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = document.getElementById('langA')?.value === 'ar' ? 'ar-SA' : 'en-US';
                    recognition.continuous = false;
                    recognition.interimResults = false;

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        this.stopVoiceRecording();
                    };

                    recognition.onerror = () => {
                        this.stopVoiceRecording();
                    };

                    recognition.start();
                    this.currentRecognition = recognition;
                } else {
                    // محاكاة للمتصفحات التي لا تدعم التعرف على الصوت
                    setTimeout(() => {
                        document.getElementById('chatInput').value = 'رسالة صوتية تجريبية';
                        this.stopVoiceRecording();
                    }, 2000);
                }
            }

            stopVoiceRecording() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (!voiceBtn) return;

                this.isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '🎤';

                if (this.currentRecognition) {
                    this.currentRecognition.stop();
                    this.currentRecognition = null;
                }
            }

            // دمج مع وظائف الحفظ الموجودة
            saveConversation() {
                if (this.currentMode === 'remote') {
                    const conversationData = {
                        mode: 'remote',
                        messages: this.chatMessages,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('remoteConversation', JSON.stringify(conversationData));
                } else {
                    // استخدام وظيفة الحفظ الموجودة للوضع العادي
                    if (typeof saveConversation === 'function') {
                        saveConversation();
                    }
                }
            }

            clearConversation() {
                if (this.currentMode === 'remote') {
                    this.chatMessages = [];
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                    }
                    localStorage.removeItem('remoteConversation');
                } else {
                    // استخدام وظيفة المسح الموجودة للوضع العادي
                    if (typeof clearConversation === 'function') {
                        clearConversation();
                    }
                }
            }
        }

        // إدارة الميكروفونات المزدوجة لوضع وجهاً لوجه
        class DualMicrophoneManager {
            constructor() {
                this.currentSpeaker = null;
                this.recognition = null;
                this.isListening = false;
                this.conversations = { a: [], b: [] };
                this.lastAudioText = { a: '', b: '' };
                
                this.initializeMicrophones();
            }

            initializeMicrophones() {
                // تهيئة التعرف على الصوت
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.updateMicrophoneUI();
                    };
                    
                    this.recognition.onresult = (event) => {
                        const text = event.results[0][0].transcript;
                        this.handleSpeechResult(text);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('خطأ في التعرف على الصوت:', event.error);
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
                
                // ربط أزرار الميكروفون
                document.getElementById('micA')?.addEventListener('click', () => this.startListening('a'));
                document.getElementById('micB')?.addEventListener('click', () => this.startListening('b'));
                
                // ربط أزرار التشغيل
                document.getElementById('playA')?.addEventListener('click', () => this.playAudio('a'));
                document.getElementById('playB')?.addEventListener('click', () => this.playAudio('b'));
            }

            startListening(speaker) {
                // التحقق من أن الوضع الحالي هو وجهاً لوجه
                if (conversationModeManager && conversationModeManager.currentMode !== 'face-to-face') {
                    return;
                }
                
                if (!this.recognition) {
                    alert('التعرف على الصوت غير مدعوم في هذا المتصفح');
                    return;
                }
                
                if (this.isListening) {
                    this.stopListening();
                    return;
                }
                
                this.currentSpeaker = speaker;
                const langSelect = document.getElementById(`lang${speaker.toUpperCase()}`);
                const selectedLang = langSelect?.value || 'ar';
                
                this.recognition.lang = this.getRecognitionLanguage(selectedLang);
                this.recognition.start();
            }

            stopListening() {
                this.isListening = false;
                this.currentSpeaker = null;
                this.updateMicrophoneUI();
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            updateMicrophoneUI() {
                const micA = document.getElementById('micA');
                const micB = document.getElementById('micB');
                
                [micA, micB].forEach(mic => {
                    if (mic) {
                        const speaker = mic.dataset.speaker;
                        const isActive = this.isListening && this.currentSpeaker === speaker;
                        
                        mic.classList.toggle('listening', isActive);
                        const micText = mic.querySelector('.mic-text');
                        if (micText) {
                            if (isActive) {
                                micText.textContent = speaker === 'a' ? 'جاري الاستماع...' : 'Listening...';
                            } else {
                                micText.textContent = speaker === 'a' ? 'اضغط للتحدث' : 'Click to speak';
                            }
                        }
                    }
                });
            }

            async handleSpeechResult(text) {
                if (!this.currentSpeaker) return;
                
                const speaker = this.currentSpeaker;
                const otherSpeaker = speaker === 'a' ? 'b' : 'a';
                
                // إضافة النص الأصلي
                this.addMessageToPane(speaker, text, 'original');
                
                // ترجمة النص
                const translatedText = await this.translateText(text, speaker, otherSpeaker);
                
                // إضافة الترجمة للطرف الآخر
                this.addMessageToPane(otherSpeaker, translatedText, 'translation', text);
                
                // حفظ النص للتشغيل الصوتي
                this.lastAudioText[otherSpeaker] = translatedText;
                
                // إظهار زر التشغيل
                const playBtn = document.getElementById(`play${otherSpeaker.toUpperCase()}`);
                if (playBtn) {
                    playBtn.style.display = 'block';
                }
                
                this.stopListening();
            }

            async translateText(text, fromSpeaker, toSpeaker) {
                const fromLang = document.getElementById(`lang${fromSpeaker.toUpperCase()}`)?.value || 'ar';
                const toLang = document.getElementById(`lang${toSpeaker.toUpperCase()}`)?.value || 'en';
                
                try {
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`);
                    const data = await response.json();
                    return data.responseData?.translatedText || text;
                } catch (error) {
                    console.error('خطأ في الترجمة:', error);
                    return `[ترجمة] ${text}`;
                }
            }

            addMessageToPane(speaker, text, type, originalText = null) {
                const scroll = document.getElementById(`scroll${speaker.toUpperCase()}`);
                if (!scroll) return;
                
                // إزالة empty state إذا كان موجوداً
                const emptyState = scroll.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let content = `<div class="message-content">`;
                
                if (type === 'translation' && originalText) {
                    content += `<div class="original-text">${originalText}</div>`;
                    content += `<div class="translated-text">${text}</div>`;
                } else {
                    content += `<div class="message-text">${text}</div>`;
                }
                
                content += `</div><div class="message-time">${timeStr}</div>`;
                messageDiv.innerHTML = content;
                
                scroll.appendChild(messageDiv);
                scroll.scrollTop = scroll.scrollHeight;
                
                // حفظ في المحادثة
                this.conversations[speaker].push({
                    text,
                    type,
                    originalText,
                    timestamp: now.toISOString()
                });
            }

            async playAudio(speaker) {
                const text = this.lastAudioText[speaker];
                if (!text) return;
                
                const lang = document.getElementById(`lang${speaker.toUpperCase()}`)?.value || 'ar';
                
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.getTTSLanguage(lang);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('خطأ في تشغيل الصوت:', error);
                }
            }

            getRecognitionLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL',
                    'sv': 'sv-SE'
                };
                return langMap[langCode] || 'ar-SA';
            }

            getTTSLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL',
                    'sv': 'sv-SE'
                };
                return langMap[langCode] || 'ar-SA';
            }
        }

        // مدير الترجمة للمحادثة عن بُعد
        class RemoteTranslationManager {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // زر تبديل اللغات
                const langSwapBtn = document.getElementById('langSwapBtn');
                if (langSwapBtn) {
                    langSwapBtn.addEventListener('click', () => {
                        this.swapLanguages();
                    });
                }

                // تحديث أزرار الإرسال والصوت للمحادثة عن بُعد
                const sendBtn = document.getElementById('sendBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                const chatInput = document.getElementById('chatInput');

                if (sendBtn) {
                    sendBtn.addEventListener('click', () => {
                        this.sendMessage();
                    });
                }

                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                }

                if (voiceBtn) {
                    voiceBtn.addEventListener('click', () => {
                        this.toggleVoiceRecording();
                    });
                }
            }

            swapLanguages() {
                const speakerLang = document.getElementById('speakerLang');
                const receiverLang = document.getElementById('receiverLang');
                
                if (speakerLang && receiverLang) {
                    const temp = speakerLang.value;
                    speakerLang.value = receiverLang.value;
                    receiverLang.value = temp;
                }
            }

            async sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // إضافة الرسالة الأصلية
                this.addChatMessage(message, 'sent', false);
                
                // ترجمة الرسالة
                await this.translateAndSend(message);
                
                // مسح حقل الإدخال
                chatInput.value = '';
            }

            async translateAndSend(message) {
                const speakerLang = document.getElementById('speakerLang')?.value || 'ar';
                const receiverLang = document.getElementById('receiverLang')?.value || 'en';
                
                if (speakerLang !== receiverLang) {
                    try {
                        const translation = await this.translateText(message, speakerLang, receiverLang);
                        this.addChatMessage(translation, 'sent', true, message);
                        
                        // تشغيل الترجمة صوتياً
                        setTimeout(() => {
                            this.speakText(translation, receiverLang);
                        }, 500);
                    } catch (error) {
                        console.error('خطأ في الترجمة:', error);
                        this.addChatMessage('خطأ في الترجمة', 'sent', true, message);
                    }
                }
            }

            async translateText(text, from, to) {
                try {
                    if (!text || text.trim().length === 0) {
                        return 'النص فارغ';
                    }

                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`);
                    const data = await response.json();
                    
                    if (data.responseStatus === 200) {
                        return data.responseData.translatedText;
                    } else {
                        return `فشل في الترجمة: ${data.responseDetails || 'خطأ غير معروف'}`;
                    }
                } catch (error) {
                    console.error('خطأ في الترجمة:', error);
                    return 'خطأ في الترجمة. يرجى المحاولة مرة أخرى.';
                }
            }

            addChatMessage(text, type, isTranslation = false, originalText = '') {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}`;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let content = `<div class="message-content">`;
                
                if (isTranslation && originalText) {
                    content += `<div class="original-text" style="font-size: 0.85em; opacity: 0.7; margin-bottom: 4px;">${originalText}</div>`;
                    content += `<div class="translated-text" style="font-weight: 600;">${text}</div>`;
                } else {
                    content += `<div class="message-text">${text}</div>`;
                }
                
                content += `</div><div class="message-time" style="font-size: 0.75em; opacity: 0.6; margin-top: 4px;">${timeStr}</div>`;
                messageDiv.innerHTML = content;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async speakText(text, lang) {
                if (!text || !('speechSynthesis' in window)) return;
                
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.getTTSLanguage(lang);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('خطأ في تشغيل الصوت:', error);
                }
            }

            getTTSLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL'
                };
                return langMap[langCode] || 'ar-SA';
            }

            toggleVoiceRecording() {
                // تطبيق التسجيل الصوتي للمحادثة عن بُعد
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('المتصفح لا يدعم التعرف على الصوت');
                    return;
                }

                const voiceBtn = document.getElementById('voiceBtn');
                const speakerLang = document.getElementById('speakerLang')?.value || 'ar';
                
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording(speakerLang, voiceBtn);
                }
            }

            startRecording(lang, button) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.lang = this.getRecognitionLanguage(lang);
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                
                this.recognition.onstart = () => {
                    this.isRecording = true;
                    button.style.background = '#ef4444';
                    button.innerHTML = '⏹️';
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = transcript;
                        this.sendMessage();
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.error('خطأ في التعرف على الصوت:', event.error);
                    this.stopRecording();
                };
                
                this.recognition.onend = () => {
                    this.stopRecording();
                };
                
                this.recognition.start();
            }

            stopRecording() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                this.isRecording = false;
                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.style.background = '';
                    voiceBtn.innerHTML = '🎤';
                }
            }

            getRecognitionLanguage(langCode) {
                const langMap = {
                    'ar': 'ar-SA',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'es': 'es-ES',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-BR',
                    'ru': 'ru-RU',
                    'ja': 'ja-JP',
                    'ko': 'ko-KR',
                    'zh': 'zh-CN',
                    'hi': 'hi-IN',
                    'tr': 'tr-TR',
                    'nl': 'nl-NL'
                };
                return langMap[langCode] || 'ar-SA';
            }
        }

        // تهيئة المدراء
        let conversationModeManager;
        let dualMicrophoneManager;
        let remoteTranslationManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            conversationModeManager = new ConversationModeManager();
            dualMicrophoneManager = new DualMicrophoneManager();
            remoteTranslationManager = new RemoteTranslationManager();
            
            // ربط أزرار الحفظ والمسح بالمدير الجديد
            const saveBtn = document.getElementById('saveChat');
            const clearBtn = document.getElementById('clearChat');
            
            saveBtn?.addEventListener('click', () => {
                conversationModeManager.saveConversation();
            });
            
            clearBtn?.addEventListener('click', () => {
                conversationModeManager.clearConversation();
            });
        });
    </script>
</body>
</html>